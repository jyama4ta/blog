<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2021-12-07T12:35:26.376Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>お問い合わせ発行時と「異なる」サブスクリプションならびに AAD テナントの調査依頼に対してのセキュリティ チェックが強化されます</title>
    <link href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/"/>
    <id>https://jpaztech.github.io/blog/information/Different-subscriptions-research/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.376Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>2021 年 12 月より、Azure ポータルから「サブスクリプション A」でお問い合わせを起票し、お問い合わせ初期あるいは途中に「サブスクリプション B」のリソースの調査を依頼されるケースにおいて、「サブスクリプション B」 側のアクセス権の有無のチェックの徹底が行われます。アクセス権を持たない場合には例外無くお問い合わせ対応を中座させていただくこととなります。<br>このため、適切なサポート リクエスト発行のための権限の付与がされたアカウントから、正しいサブスクリプションとリソース名を選択してお問い合わせを起票いただきますようお願いします。<br><br>※ Azure Active Directory (AAD) に関しても同様で、正しい AAD テナントからのお問い合わせの発行をお願いいたします。</p><p>後述の詳細では、この背景ならびに設定方法、また例外的なシナリオについてご説明します。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="[詳細]"></a>[詳細]</h2><p>マイクロソフトのクラウド プラットフォームではお客様の情報保護を最優先に運営しております。<br>サポートにおいても GDPR などの各国・地域におけるセキュリティ要件に準拠し、サポート担当者や使用ツールなどのセキュリティ ホールが無いようにつとめています。<br>Azure サポートにおいても原則として、影響があったサブスクリプションから、適切な権限を持つユーザーからのお問い合わせのみを受け付けるというポリシーとなっています。</p><p>Azure サポート要求を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request">https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request</a></p><blockquote><p>Azure ロールベースのアクセス制御<br>サポート リクエストを作成するには、<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#owner">所有者</a>か、<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#contributor">共同作成者</a>か、またはサブスクリプション レベルで<a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#support-request-contributor">サポート リクエスト共同作成者</a>ロールが割り当てられている必要があります。<br>Azure Active Directory シナリオなどのサブスクリプションを使用せずにサポート リクエストを作成するには、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/roles/permissions-reference">管理者</a>である必要があります。</p></blockquote><p>本ポリシーは数年来存在しており、原則としてこのポリシーに従って運用を行ってまいりましたが、<br>これまで、例外的に、ユーザーからの権限を有する証跡などの提示などがなされた場合に対応が許容されるケースが存在しました。<br>一方で、<a href="https://blogs.microsoft.com/on-the-issues/2021/10/24/new-activity-from-russian-actor-nobelium/">昨今の大規模なサイバー攻撃</a>に代表される、顧客情報漏洩のリスクが日々高まる状況となっています。<br>上記ポリシーをあらためてシステマチックに実装し、徹底することで、サポート経由でのソーシャル ハッキング、あるいはサポート担当者のクレデンシャル漏洩時のサポート ツールの悪用によるリスクを回避します。</p><p>上記 URL に記載のとおり、Azure サポートをご利用いただくお客様には、適切な権限 (サブスクリプション レベルにて “所有者”、”共同作成者”、ないしは “サポート リクエスト共同作成者”) を設定の上、適切なサブスクリプションとリソース名を選択してお問い合わせください。</p><h2 id="異なるサブスクリプションの調査の必要性が発生するシナリオの例"><a href="#異なるサブスクリプションの調査の必要性が発生するシナリオの例" class="headerlink" title="[異なるサブスクリプションの調査の必要性が発生するシナリオの例]"></a>[異なるサブスクリプションの調査の必要性が発生するシナリオの例]</h2><p>ご用件によって、異なるサブスクリプションの調査が必要となるシナリオが存在します。<br>一例として、同じ問題ではあるが、複数のサブスクリプションの参照が求められるトラブルシュートが発生する場合が挙げられます。<br>例えば、「サブスクリプション A」上の VM と「サブスクリプション B」上の VM の間での接続不良が発生し、両方の調査が求められるという状況です。<br>この場合、1 件で異なるサブスクリプションの調査が行える場合がございますが、その際には必ず、異なるサブスクリプション側にも、お問い合わせ起票者と同じユーザー アカウントが、”所有者”、”共同作成者”、ないしは “サポート リクエスト共同作成者”として設定されている必要があります。</p><p>※この設定がない場合、解析を行うツール側でのセキュリティ チェックが行えないため、調査が行えません。<br>そのような場合、以下のワークアラウンドにご協力ください。</p><h2 id="異なるサブスクリプションについて調査が必要な場合のワークアラウンド"><a href="#異なるサブスクリプションについて調査が必要な場合のワークアラウンド" class="headerlink" title="[異なるサブスクリプションについて調査が必要な場合のワークアラウンド]"></a>[異なるサブスクリプションについて調査が必要な場合のワークアラウンド]</h2><p>サブスクリプション A、サブスクリプション B それぞれから、合計 2 件のお問い合わせを起票してください。後から起票したサブスクリプションには、先に起票したお問い合わせ番号を記入してください。サポート担当者より、2件が関連していることを把握し、スムースに対応させていただきます。<br>サブスクリプション A、サブスクリプション B の管理者が異なる場合も、連携して調査行うことが可能ですが、必ず後からお問い合わせを起票した側のサブスクリプション側では、「先に発行したお問い合わせ番号」と、「情報開示・連携を行ってもよい」という一言を併記ください。</p><h2 id="補足-CSP-サブスクリプションでの問い合わせについて"><a href="#補足-CSP-サブスクリプションでの問い合わせについて" class="headerlink" title="[補足: CSP サブスクリプションでの問い合わせについて]"></a>[補足: CSP サブスクリプションでの問い合わせについて]</h2><p>CSP パートナーは、CSP エンド ユーザー サブスクリプションの環境で発生した問題についてファースト ラインのサポートを提供し、解決が難しい場合にマイクロソフトにお問い合わせをいただくこととなります。<br>この際も、必ず、問題が発生した CSP エンド ユーザー サブスクリプションからお問い合わせを発行してください。<br>なお、この際には CSP パートナーとして、CSP エンド ユーザー サブスクリプションに対しての代理管理者 (AOBO = Admin On Behalf Of) の権限を有し、環境にアクセスできる状態としていただく必要があります。<br>適切なアクセス権を有しないお客様において、無関係なサブスクリプションからお問い合わせを起票し、サポート担当者に対して調査対象サブスクリプションを要請される場合がございますが、前述のセキュリティ上の制限に抵触する場合には調査続行が不可能なため、対応を中座させていただくこととなります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;2021 年 12 月より、Azure ポータルから「サブスクリプション A」でお問い合わせを起票し、お問い合わせ初期あるいは途中に「サブスクリプション B」のリソースの調査を依頼されるケースにおいて、「サブスク</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>電話経由における Azure サブスクリプションの調査のセキュリティ チェックが厳格化されます</title>
    <link href="https://jpaztech.github.io/blog/information/Security-check-stricter/"/>
    <id>https://jpaztech.github.io/blog/information/Security-check-stricter/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.376Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>12/8 (水) より、Premier サポートなどの電話経由におけるお問い合わせ発行の際、Azure サブスクリプション上のリソースに対して調査を行う必要がある場合、セキュリティ チェックが厳格化されます。<br>※リソースに依存しない、一般的な Q&amp;A の内容の場合には無関係です。</p><p>電話経由でサポート リクエストの起票を行う場合には、お問い合わせ起票の際にご連絡いただくメール アドレス (＝ ユーザー アカウント) が、調査対象となるサブスクリプションの所有者か、共同作成者か、またはサブスクリプション レベルでサポート リクエスト共同作成者ロールに割り当てられている必要があります。<br><span style="color: red; ">※この権限を有さない場合、調査が困難となりますので、対応を中座し適切な権限を持つユーザーからのお問い合わせの再起票をお願いすることとなります。</span></p><p>なお、Azure サポートにおいては、可能な限り Azure ポータル経由でのお問い合わせを推奨します。<br>電話経由でのサポートは、Azure ポータルに何らかの理由でアクセスできない場合に備え残っておりますが、効率性は低い方法となります。  電話の場合、お問い合わせ起票の後のサポート担当者の決定後、サブスクリプション ID や影響のあったリソース名のヒアリングが行われた後に調査となります。<br>Azure ポータルの場合、サブスクリプション ID とリソース名があらかじめ指定いただける上、サポートで用いる自動解析ツールが事前に実行されるなど内部的な効率化も図られていることから、Azure ポータルのほうがより効果的な解決を行えるものとなります。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="[詳細]"></a>[詳細]</h2><p>マイクロソフトのクラウド プラットフォームではお客様の情報保護を最優先に運営しております。<br>サポートにおいても GDPR などの各国・地域におけるセキュリティ要件に準拠し、サポート担当者や使用ツールなどのセキュリティ ホールが無いようにつとめています。Azure サポートにおいても原則として、影響があったサブスクリプションから、適切な権限を持つユーザーからのお問い合わせのみを受け付けるというポリシーとなっています。</p><p>Azure サポート要求を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request">https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request</a></p><blockquote><p>Azure ロールベースのアクセス制御<br>サポート リクエストを作成するには、所有者か、共同作成者か、またはサブスクリプション レベルでサポート リクエスト共同作成者ロールが割り当てられている必要があります。<br>Azure Active Directory シナリオなどのサブスクリプションを使用せずにサポート リクエストを作成するには、管理者である必要があります。</p></blockquote><p>本ポリシーは数年来存在しており、原則としてこのポリシーに従って運用を行ってまいりましたが、これまで、例外的に、ユーザーからの権限を有する証跡などの提示などがなされた場合に対応が許容されるケースが存在しました。<br>一方で、昨今の大規模なサイバー攻撃に代表される、顧客情報漏洩のリスクが日々高まる状況となっています。<br>上記ポリシーをあらためてシステマチックに実装し、徹底することで、サポート経由でのソーシャル ハッキング、あるいはサポート担当者のクレデンシャル漏洩時のサポート ツールの悪用によるリスクを回避します。</p><p>Premier サポートによる電話起票においては、上記のようなシステム的なセキュリティ チェックが行えない関係上、一部のサポート シナリオにおける調査方法が制限される場合があるため、Azure ポータルからの起票を推奨します。<br>また、電話起票の場合にも、必ずお問い合わせ起票者のユーザー アカウント = お問い合わせ時に指定いただく E-mail アドレス にて、対象サブスクリプションの調査権限を設定いただいていることをご確認ください。電話でのお問い合わせ起票後の担当者変更によるセキュリティの再チェックは行えません。<br>(例: ユーザー A が電話にてお問い合わせを起票したが、対象サブスクリプションに調査権限が無い場合に、あとから口頭あるいはメールなどにて適切な権限を持つユーザー B を紹介いただくケース。この場合も調査続行は行えませんので、正しいアクセス権を持つユーザー B からお問い合わせを発行してください。)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;12/8 (水) より、Premier サポートなどの電話経由におけるお問い合わせ発行の際、Azure サブスクリプション上のリソースに対して調査を行う必要がある場合、セキュリティ チェックが厳格化されます。&lt;b</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>サブスクリプション ID とリソース ID の確認について</title>
    <link href="https://jpaztech.github.io/blog/information/Subscription-ID-verification/"/>
    <id>https://jpaztech.github.io/blog/information/Subscription-ID-verification/</id>
    <published>2021-11-26T03:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.376Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームです。</p><p>お客様から日々お問い合わせ頂いている内容について、正確に調査や状況確認を行うために、我々サポートエンジニアからお客様にリソース情報 (サブスクリプション ID 、リソース ID) をお伺いすることがあります。<br>本トピックでは、このサブスクリプション ID とリソース ID の確認方法についてご紹介いたします。</p><h2 id="サブスクリプション-ID-とは"><a href="#サブスクリプション-ID-とは" class="headerlink" title="サブスクリプション ID とは"></a>サブスクリプション ID とは</h2><p>Microsoft Azure をご利用頂く際に、お客様と日本マイクロソフト株式会社は、無償または有償のサブスクリプション契約 (無料評価版、従量課金プラン等) を結びます。<br>お客様が締結したこのサブスクリプション契約を一意のものとして識別するために、マイクロソフトでは 32 桁の GUID を付与しています。この GUID がサブスクリプション ID で以下のフォーマットで表記されます。</p><p>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</p><h2 id="サブスクリプション名とサブスクリプション-ID-の確認方法について"><a href="#サブスクリプション名とサブスクリプション-ID-の確認方法について" class="headerlink" title="サブスクリプション名とサブスクリプション ID の確認方法について"></a>サブスクリプション名とサブスクリプション ID の確認方法について</h2><p>以下では、Azure Portal からサブスクリプション名とサブスクリプション ID 確認する方法についてご案内いたします。</p><ol><li><p>Azure ポータルにサインインします。</p></li><li><p>Azure Poral ホーム画面上部の検索バーから [サブスクリプション] と検索 / Azure Portal ホーム画面下部の移動から [サブスクリプション]をクリックします。</p></li></ol><p><img src="/blog/information/Subscription-ID-verification/01.png"></p><ol start="3"><li><p>表示されたサブスクリプション一覧から、該当のサブスクリプションを選択しクリックします。<br><img src="/blog/information/Subscription-ID-verification/02.png"></p></li><li><p>画面上部にサブスクリプション名とサブスクリプション ID が表示されます。</p></li><li><p>カーソルを合わせると[クリップボードにコピー]が表示されます。</p></li></ol><p><img src="/blog/information/Subscription-ID-verification/03.png"></p><h3 id="特定のリソースからサブスクリプション名とサブスクリプション-ID-を確認する"><a href="#特定のリソースからサブスクリプション名とサブスクリプション-ID-を確認する" class="headerlink" title="特定のリソースからサブスクリプション名とサブスクリプション ID を確認する"></a>特定のリソースからサブスクリプション名とサブスクリプション ID を確認する</h3><p>特定のリソースからサブスクリプション名とサブスクリプション ID を確認するためには、リソースの概要画面上部から確認できます。<br><img src="/blog/information/Subscription-ID-verification/04.png"></p><h2 id="リソース-ID-とは"><a href="#リソース-ID-とは" class="headerlink" title="リソース ID とは"></a>リソース ID とは</h2><p>Azure のリソース ID とは Azure Resource Manager におけるリソースの一意な識別子を示しており、以下のフォーマットで表記されます。<br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProviderName}/ {resourceType}/{resourceName}</p><h2 id="リソース-ID-の確認方法について"><a href="#リソース-ID-の確認方法について" class="headerlink" title="リソース ID の確認方法について"></a>リソース ID の確認方法について</h2><ol><li><p>調査対象のリソースの概要画面の右部の [JSON ビュー] をクリックします。 (例では Azure VM を示す。)<br><img src="/blog/information/Subscription-ID-verification/05.png"></p></li><li><p>JSON ビュー上部にリソース ID が表示されます。</p></li><li><p>カーソルを合わせると[クリップボードにコピー]が表示されます。<br><img src="/blog/information/Subscription-ID-verification/06.png"></p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームです。&lt;/p&gt;
&lt;p&gt;お客様から日々お問い合わせ頂いている内容について、正確に調査や状況確認を行うために、我々サポートエンジニアからお客様にリソース情報 (サブスクリプション ID 、リソース ID) をお伺いすることがあります。&lt;b</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
    <category term="Azure Portal" scheme="https://jpaztech.github.io/blog/tags/Azure-Portal/"/>
    
  </entry>
  
  <entry>
    <title>特定のユーザーへ仮想マシンの起動 / 停止 / 再起動 のみの操作を許可する方法</title>
    <link href="https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/"/>
    <id>https://jpaztech.github.io/blog/vm/rbac-vm-start-stop-restart/</id>
    <published>2021-11-11T02:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.584Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回は、よくお問い合わせを頂く、特定のユーザーに対して、<br>仮想マシンの 起動 / 停止 / 再起動 のみの操作を実行できるようにする方法について<br>Azure portal 上のスクリーンショット付きで設定の手順をご紹介いたします。</p><p>本手順を実施することで、特定のユーザーは仮想マシンに対して、削除等の操作を実施できなくなり、<br>誤って仮想マシンを削除するといった問題を事前に防ぐことができます。</p><span id="more"></span><hr><h2 id="RBAC-とは"><a href="#RBAC-とは" class="headerlink" title="RBAC とは ?"></a>RBAC とは ?</h2><p>Azure では、ロールベースのアクセス制御 (RBAC) という機能を使用し、<br>アクセスできるリソースを制限や、リソースへの操作を制限することが可能となります。<br>Azure には複数の組み込みロールのご用意がありますが、<br>独自のカスタムロールを作成することで、必要最低限のリソースへの操作を許可することができます。</p><blockquote><p> □ 参考 : Azure ロールベースのアクセス制御 (Azure RBAC) とは<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/overview">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/overview</a></p><p> □ 参考 : Azure 組み込みロール<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※カスタムロールを作成するには、所有者やユーザー アクセス管理者など、カスタム ロールを作成するための権限を持つユーザーでの操作が必要となります。</p></div><hr><h2 id="必要な権限について"><a href="#必要な権限について" class="headerlink" title="必要な権限について"></a>必要な権限について</h2><p>仮想マシンの起動 / 停止 / 再起動の操作を行うために最低限必要なリソースプロバイダ (操作項目) は、次の4つです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>“Microsoft.Compute/virtualMachines/read”                // 仮想マシンのプロパティを取得します</p><p>“Microsoft.Compute/virtualMachines/start/action”        // 仮想マシンを起動します</p><p>“Microsoft.Compute/virtualMachines/deallocate/action”   // 仮想マシンを電源オフにし、コンピューティング リソースを解放します。</p><p>“Microsoft.Compute/virtualMachines/restart/action”      // 仮想マシンを再起動します。</p></div><p>リソースプロバイダを追加したい際には、下記の公開ドキュメントから<br>ご要望のリソースプロバイダを追加頂くことも可能です。</p><blockquote><p> □ 参考 : Azure リソース プロバイダーの操作<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/resource-provider-operations#microsoftcompute</a></p></blockquote><hr><h2 id="カスタムロールを作成する手順"><a href="#カスタムロールを作成する手順" class="headerlink" title="カスタムロールを作成する手順"></a>カスタムロールを作成する手順</h2><ol><li>Azure portal から、カスタム ロールを割り当て可能にするサブスクリプションを開き、<br>“アクセス制御 (IAM)” から [+ 追加] をクリックし、[カスタムロールの追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/01.png"></p><ol><li>任意のカスタムロール名を入力し、必要に応じてカスタムロールの説明を入力します。<br>ここでは、testrole というカスタムロール名で作成します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/02.png"></p><ol start="3"><li>アクセス許可のタブへ移動し、[アクセス許可の追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/03.png"></p><ol start="4"><li>下記のような、画面に移りますので、”アクセス許可を検索してください” に許可したいリソースプロバイダを入力してください。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/04.png"></p><ol start="5"><li>“Microsoft.Compute/virtualMachines/read” を入力すると、対象のアクセス許可が表示されますので、<br>チェックを入れ、[追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/05.png"></p><ol start="6"><li>同様の手順で、残りの 3 つの権限も追加します。</li></ol><blockquote><p>“Microsoft.Compute/virtualMachines/start/action”<br>“Microsoft.Compute/virtualMachines/deallocate/action”<br>“Microsoft.Compute/virtualMachines/restart/action”</p></blockquote><ol start="7"><li>下記の通り、4 つアクセス許可が追加されたことが確認できます。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/06.png"></p><ol start="8"><li>[JSON] のタブから、JSON 形式でも、アクセス許可を編集することが可能になります。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/07.png"></p><ol start="9"><li>アクセス許可を追加したあとは、カスタムロールを作成します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/08.png"></p><p>これで、カスタムロールの作成が完了です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>カスタムロールの作成後、反映には、数分かかる場合がございます。</p></div><p><img src="/blog/vm/rbac-vm-start-stop-restart/09.png"></p><hr><h2 id="カスタムロールをユーザーに割り当てる"><a href="#カスタムロールをユーザーに割り当てる" class="headerlink" title="カスタムロールをユーザーに割り当てる"></a>カスタムロールをユーザーに割り当てる</h2><p>次は、特定のユーザーに対して、カスタムロールを割り当てていきます。</p><ol><li>カスタム ロールを割り当て可能にするサブスクリプションを開き、”アクセス制御 (IAM)” から<br>[+ 追加] をクリックし、[ロールの割り当ての追加] を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/10.png"></p><ol start="2"><li>[ロールの割り当ての追加] に、登録されているすべてのロールが表示されますので、<br>作成したカスタムロールを選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/11.png"></p><ol start="3"><li>[メンバー] のタブから、[+ メンバーを選択する] を選択します。<br>画面右端に、カスタムロールを割り当てたい特定のユーザーを選択します。<br>ここでは、testuser という特定のユーザーを選択します。<br>(グループを選択することも可能です。)</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/12.png"></p><ol start="4"><li>ロールの割り当てに問題がなければ、”レビューと割り当て” を選択します。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/13.png"></p><ol start="5"><li>しばらくすると、ロールの割り当てが追加されます。</li></ol><p><img src="/blog/vm/rbac-vm-start-stop-restart/14.png"></p><p>これで、特定のユーザーに対して、仮想マシンの起動 / 停止 / 再起動が許可されました。<br>それでは、testuser で、Azure portal へログインし、仮想マシンが起動できるか確認します。<br>下記の通り、無事に仮想マシンの起動ができました。</p><p><img src="/blog/vm/rbac-vm-start-stop-restart/15.png"></p><p>testuser は、仮想マシンの起動 / 停止 / 再起動の操作が許可されています。<br>そのため、仮想マシンの削除を実施しようとすると、下記画像のように<br>権限エラーとなり仮想マシンの削除は実施できなくなります。</p><p><img src="/blog/vm/rbac-vm-start-stop-restart/16.png"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>※カスタムロールの設定が反映されていない場合には、一度 Azure portal からログアウトし、再度ログインをお試しください。</p></div><p>カスタムロールの作成方法につきましては、下記の公式ドキュメントにもございます。</p><blockquote><p> □ 参考：Azure portal を使用して Azure カスタム ロールを作成または更新する<br>    <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal</a></p></blockquote><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>RBAC の権限付与は、管理グループ、サブスクリプション、リソースグループ、リソース<br>いずれかのスコープに対して適用することが可能となります。<br>今回、サブスクリプションをスコープとしたカスタムロールを割り当てたため、<br>サブスクリプション内に存在する全ての仮想マシンに対して同様の操作が実施可能になります。</p><p>特定の複数の仮想マシンに対して権限付与をしたい場合には、<br>対象の仮想マシンが所属するリソースグループや<br>仮想マシンひとつひとつに対して権限付与を行っていただくことが可能になります。<br>（親スコープに設定された権限は、子スコープに継承されます。）</p><blockquote><p> □ 参考 : Azure RBAC のスコープについて<br>   <a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview">https://docs.microsoft.com/ja-jp/azure/role-based-access-control/scope-overview</a></p></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回は、よくお問い合わせを頂く、特定のユーザーに対して、&lt;br&gt;仮想マシンの 起動 / 停止 / 再起動 のみの操作を実行できるようにする方法について&lt;br&gt;Azure portal 上のスクリーンショット付きで設定の手順をご紹介いたします。&lt;/p&gt;
&lt;p&gt;本手順を実施することで、特定のユーザーは仮想マシンに対して、削除等の操作を実施できなくなり、&lt;br&gt;誤って仮想マシンを削除するといった問題を事前に防ぐことができます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="RBAC" scheme="https://jpaztech.github.io/blog/tags/RBAC/"/>
    
  </entry>
  
  <entry>
    <title>2021 年 10 月 13 日に発生した仮想マシンの問題について (Tracking ID 0NC_-L9G)</title>
    <link href="https://jpaztech.github.io/blog/vm/20211013-rca-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/20211013-rca-azure-vm/</id>
    <published>2021-10-18T02:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.464Z</updated>
    
    <content type="html"><![CDATA[<p>いつも Azure IaaS テクニカル サポート チームのブログを参照いただきましてありがとうございます。</p><p>今回は日本時間の 10/13 に発生しました仮想マシンの障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は <a href="https://azure.microsoft.com/ja-jp/status/history/">状態の履歴および根本原因分析 (RCA)</a> を確認ください。</p><p>日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。</p><p><a href="/blog/vm/20211013-rca-azure-vm/0NC_-L9G.pdf">0NC_-L9G.pdf</a></p><p>本障害では、仮想マシンをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。あらためて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。</p><span id="more"></span><h2 id="影響の概要"><a href="#影響の概要" class="headerlink" title="影響の概要:"></a>影響の概要:</h2><p>日本時間 10 月 13 日 午後 3 時 27 分から午後 9 時 42 分まで Windows ベースの仮想マシンをご利用されている一部のお客様で、起動、作成、更新、削除などの管理オペレーションを実施されている時、失敗のメッセージを受け取られた可能性がございます。また、新規仮想マシンのデプロイや拡張機能の更新も、失敗となっていた可能性がございます。可用性セットや仮想マシンのスケールセットへのオペレーションも同様に影響を受けていました。</p><p><u>Windows ベースではない仮想マシンは影響を受けなかったものの、Windows の仮想マシンに依存しているサービスは、リソース作成時に同様の影響を受けていた可能性がございます。</u></p><h2 id="原因"><a href="#原因" class="headerlink" title="原因:"></a>原因:</h2><p>Windows ベースの仮想マシンは、仮想マシンと Azure ファブリック間の相互作用を管理する Windows 仮想マシンエージェント(VM エージェント)を利用します。</p><p>Windows 仮想マシンの作成や更新を実施する際、Computer Resource Provider（CRP）はプラットフォームイメージリポジトリから最新版の VM エージェントパッケージのダウンロードするロケーションを取得いたします。VM エージェントはこの取得した情報を用いて、仮想マシン内でエージェントを最新版に更新します。</p><p>クラシックリソースを Azure Resource Manager (ARM) へ移行する行程の一つとして、弊社はイメージと拡張機能の発行元を、地域的(リージョナル)な ARM 発行パイプラインへマイグレーションしており、現在は約 20% 程完了しております。</p><p>午後 3 時 27 分ころ、弊社内のツールはこれらの移行を行うため ARM テンプレートを生成しましたが、このツールはエッジケース（最大や最小限の動作パラメータでのみ発生する問題または状況) を考慮していなかったため、意図されてない結果として、マイグレーション後に、 ARM リージョナルサービス内でのみ発行されているサブスクリプションに対して、Windows VM エージェント拡張機能が表示されるようマークされてしまいました。その結果、地域的なプラットフォームイメージリポジトリから何も受け取れず（zero results）、VM 管理オペレーションが失敗し始めました。</p><p>お客様の Windows 仮想マシンにおける起動、停止、作成や削除などのオペレーションは Windows VM エージェントの拡張機能を見つけることができなかったため、完了することができない結果となってしまいました。 </p><p>私たちの変更管理のプロセスの一部は、Safe Deployment Practice (SDP) のフレームワークをレバレッジすることです。<br><a href="https://azure.microsoft.com/en-us/blog/advancing-safe-deployment-practices/">(https://azure.microsoft.com/en-us/blog/advancing-safe-deployment-practices/)</a>.　この場合、弊社クラシックモデルのインフラ機能のいくつかは SDP フレームワークと合致しません。この不適合性は私たちが ARM への完全なマイグレーションを行う重要性を強調するものになります。マイグレーションが完了しましたら、クラシックリソースに特化したツールを使わないまま、SDP フレームワーク使用し、すべて変更ができるようになります。</p><h2 id="緩和策"><a href="#緩和策" class="headerlink" title="緩和策:"></a>緩和策:</h2><p>根本原因の特定にあたり、Azure コンポーネント用の複数のリリースがプラットフォーム上で同時に実行されており、それぞれを調査するため時間を要することになりました。根本的な原因を確実に特定できるよういくつかの想定されるシナリオを排除するため、それらに関連するコンポーネントに特化した技術者たち（SMEs）が調査対応を進めていたことも時間を要した理由でした。</p><p>私たちは問題自体を確定し、いくつかの緩和策を確認した後、まず始めに一つの地域にて拡張機能を公開し影響を軽減させて、その結果を検証しました。そして仮想マシンへの膨大なリクエストでもこれ以上影響が出ない事を確認いたしました。この検証の後、一つ一つの地域で新しいパイプラインへの変更を展開し始め、事象緩和へと至りました。変更が完了した後、エンジニアたちはオペレーションの成功率を監視しておりました。</p><h2 id="次のステップ"><a href="#次のステップ" class="headerlink" title="次のステップ:"></a>次のステップ:</h2><p>影響があったお客様へ深くお詫び申し上げます。Microsoft Azure プラットフォームの改善、そして将来的にこのような障害が再発しないよう私たちは下記を継続して取り組んでいきます。</p><ul><li>すべての復旧作業が実施されるまで、未実施のパッケージ（Linux バージョンの VM エージェントも含む）のマイグレーションを一時中断します。</li><li>追加の事前確認 (pre-check) と事後確認 (post-check) を開発し、実装いたします。</li><li>VM オペレーション中に VM エージェントが見つからないエラーが発生したとき、VM オペレーションがエラーから復旧できるよう改善いたします。</li><li>エンジニア部門は各拡張タイプをフライトするため、そしてマイグレーションの残工程に存在しうる障害を防ぐために、他の安全策も評価しています。</li></ul><h2 id="フィードバックのお願い"><a href="#フィードバックのお願い" class="headerlink" title="フィードバックのお願い:"></a>フィードバックのお願い:</h2><p>Azure カスタマー・コミュニケーション・エクスペリエンスの向上のためのアンケートにご協力ください: <a href="https://aka.ms/AzurePIRSurvey">https://aka.ms/AzurePIRSurvey</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;いつも Azure IaaS テクニカル サポート チームのブログを参照いただきましてありがとうございます。&lt;/p&gt;
&lt;p&gt;今回は日本時間の 10/13 に発生しました仮想マシンの障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は &lt;a href=&quot;https://azure.microsoft.com/ja-jp/status/history/&quot;&gt;状態の履歴および根本原因分析 (RCA)&lt;/a&gt; を確認ください。&lt;/p&gt;
&lt;p&gt;日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/blog/vm/20211013-rca-azure-vm/0NC_-L9G.pdf&quot;&gt;0NC_-L9G.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本障害では、仮想マシンをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。あらためて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway - App Service 間のリダイレクトの問題</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-appservice-redirectissue/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-appservice-redirectissue/</id>
    <published>2021-10-14T03:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.384Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの大塚です。</p><p>この記事では Application Gateway と App Service を組み合わせた時によくお問い合わせをいただくリダイレクトの問題についてご紹介させていただきます。</p><span id="more"></span><hr><h3 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h3><p>Application Gateway のバックエンドにマルチテナントである App Service を指定するシナリオでは、App Service の 既定の FQDN（xxx.azurewebsites.net）をバックエンドに配置し、この FQDN でホスト名の上書きを行うことで実現させることが一般的です。<br>※詳細は<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/configure-web-app-portal">こちら</a>のドキュメントをご参照ください。 </p><p>しかしながら Application Gateway のフロント エンドにカスタム ドメインを設定しており、バックエンドに指定した App Service 側でリダイレクトの応答が返されるシナリオでは前述の構成だと意図せず App Service の 既定の FQDN が利用されてしまい期待した動作とならない場合があります。</p><p>この場合のトラブルシュートについては<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/troubleshoot-app-service-redirection-app-service-url">こちら</a>のドキュメンとに対処方法が記載されております。このブログではこのドキュメントの手順をもう少しかみくだきご紹介いたします。</p><h4 id="現在の構成"><a href="#現在の構成" class="headerlink" title="現在の構成"></a>現在の構成</h4><p>まず、現在の構成は以下とします。この状態でクライアントから 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> に接続すると、ブラウザの URL 表示が App Service のFQDN となってしまう事象が発生しています。これをカスタムドメインで表示させることが目的です。</p><ul><li>   カスタム ドメイン 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> は Application Gateway のパブリック IP アドレスに名前解決されるように構成済み</li><li>   Application Gateway のバックエンド プールには App Service の既定の FQDN 「maotsuwebapp.azurewebsites.net」 を設定し HTTP 設定とカスタム プローブでバックエンドターゲットからホスト名を選択する設定をいれている</li></ul><p><img src="/blog/network/appgw-appservice-redirectissue/01.png"></p><p><span id="application-gateway-issue-check"></span></p><h2 id="App-Service-のリダイレクトの問題に合致しているかどうかの確認"><a href="#App-Service-のリダイレクトの問題に合致しているかどうかの確認" class="headerlink" title="App Service のリダイレクトの問題に合致しているかどうかの確認"></a><a href="#application-gateway-issue-check">App Service のリダイレクトの問題に合致しているかどうかの確認</a></h2><p>現在発生している問題がリダイレクトの問題かどうか確認しましょう。確認にはブラウザの F12 キーを押し開発者ツールを使用し、Network タブを確認します。※<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace">参考サイトはこちら</a></p><p>確認してみるとクライアントから 「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> に接続すると、応答ヘッダー内の Location ヘッダーにApp Service の既定の FQDN が入り、リダイレクトの指示がされています。</p><p><img src="/blog/network/appgw-appservice-redirectissue/02.png"></p><p>この場合、App Service のリダイレクトの問題に合致しているので、後述の方法で対処することでリダイレクト構成時にもアドレスバーの FQDN をカスタム ドメインで構成することが可能です。</p><h3 id="リダイレクトの問題の対応方法"><a href="#リダイレクトの問題の対応方法" class="headerlink" title="リダイレクトの問題の対応方法"></a>リダイレクトの問題の対応方法</h3><p>このリダイレクトの問題を対処するには次の２ つの方法があります。使い分け分けとしては大まかに以下のように整理できます。</p><ul><li><p><strong>Application Gateway の書き換え規則をつかう</strong><br>Application Gateway V2 SKU を利用の場合で、Location ヘッダーのみの書き換えで対応が可能な場合</p></li><li><p><strong>カスタム ドメインをつかう</strong><br>Application Gateway V1 SKU を利用の場合、または V2 SKU を利用しているものの referer ヘッダーや Cookie などにもドメインが含まれていて書き換えでの対応が複雑となる場合</p></li></ul><p>それではそれぞれの対応方法について見てみましょう。</p><p><span id="application-gateway-rewrite"></span></p><h2 id="Application-Gateway-の書き換え規則をつかう"><a href="#Application-Gateway-の書き換え規則をつかう" class="headerlink" title="Application Gateway の書き換え規則をつかう"></a><a href="#application-gateway-rewrite">Application Gateway の書き換え規則をつかう</a></h2><p>Application Gateway V2 から追加された「書き換え規則」を使います。設定内容は下記の通りです。<br>※書き換え規則の設定方法の詳細については<a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/rewrite-http-headers-url#modify-a-redirection-url">こちら</a>もご参照ください。</p><h4 id="必要な作業"><a href="#必要な作業" class="headerlink" title="必要な作業"></a>必要な作業</h4><ul><li>「If（条件）」の一致させるパターン ： <code>(https?):\/\/.*azurewebsites\.net(.*)$</code></li><li>「Then（結果）」 のヘッダー値 ：<code>&#123;http_resp_Location_1&#125;://&lt;カスタム ドメイン名&gt;&#123;http_resp_Location_2&#125;</code></li></ul><p><img src="/blog/network/appgw-appservice-redirectissue/03.png"></p><p><span id="application-gateway-custom-domain"></span></p><h2 id="カスタム-ドメインをつかう"><a href="#カスタム-ドメインをつかう" class="headerlink" title="カスタム ドメインをつかう"></a><a href="#application-gateway-custom-domain">カスタム ドメインをつかう</a></h2><h4 id="必要な作業-1"><a href="#必要な作業-1" class="headerlink" title="必要な作業"></a>必要な作業</h4><p><strong>1. App Service側にもカスタムドメイン「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> を登録する</strong><br><strong>2. Application Gateway 側で HTTP 設定とカスタム プローブの変更する</strong><br><strong>3. 動作の確認</strong><br>それぞれの作業内容についてご説明します。</p><hr><h3 id="1-App-Service側にもカスタムドメイン「www-maotsunet-com」-を登録する"><a href="#1-App-Service側にもカスタムドメイン「www-maotsunet-com」-を登録する" class="headerlink" title="1. App Service側にもカスタムドメイン「www.maotsunet.com」 を登録する"></a>1. App Service側にもカスタムドメイン「<a href="http://www.maotsunet.com」/">www.maotsunet.com」</a> を登録する</h3><p>App Service はマルチテナント サービスのため、IP アドレスでのリクエストを受け入れることはできません。<br>そのため、既定の FQDN 以外で接続したい場合は事前にカスタム ドメインの登録を行う必要があります。<br>App Service にカスタム ドメインを設定する際に、カスタム ドメインの CNAME が既にApplication Gatewayなど WebApps 以外に向いている場合、カスタム ドメインの設定はできません。<br>このような場合、App Service の「カスタム ドメインの検証 ID」を使用し、asuid という名前の TXT レコードを作成することで回避することが可能です。<br>例えば、カスタム ドメインに<a href="http://www.maotsunet.com/">www.maotsunet.com</a> を登録しようとしている場合 ｍaotsunet.com の DNS ゾーンに以下のレコードを追加します。App Service 側にカスタム ドメインを追加する作業の詳細については<a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-web-tutorial-custom-domain?tabs=cname#3-get-a-domain-verification-id">こちら</a>もご参照ください。</p><ol><li><p>App Service のカスタム ドメインの項目から「カスタム ドメイン検証 ID」をコピーします。<br><img src="/blog/network/appgw-appservice-redirectissue/dnstxt.jpg" alt="カスタム ドメインの検証 ID をコピー"></p></li><li><p>   「ｍaotsunet.com」 ゾーンを管理しているDNS サーバーに以下のようなレコードを追加します。</p></li></ol><ul><li>名前：asuid.&lt;ホスト名&gt;</li><li>種類：TXT</li><li>値：コピーしたカスタムドメインの検証 ID</li></ul><p>【例】<a href="http://www.maotsunet.com/">www.maotsunet.com</a> というカスタムドメインで、 maotsuwebapp.azurewebsites.net という App Service のドメインの場合</p><ul><li>名前：asuid.www</li><li>種類：TXT</li><li>値：123456789123456789123456789XXXXXXX</li></ul><p>(※) Azure DNS でゾーンの管理している場合は下記のように構成します</p><p><img src="/blog/network/appgw-appservice-redirectissue/azdns.jpg"></p><p>これによって、カスタム ドメイン設定時の検証において、asuid のレコードを参照して検証を行うため、元のホスト名の CNAME が Application Gateway など WebApps 以外に向いている状態でカスタム ドメインが設定可能となります。</p><p>3）対象の WebApps の設定にてカスタム ドメインの 「検証」 ・ 「カスタム ドメインの追加」 を行います<br><img src="/blog/network/appgw-appservice-redirectissue/domainkensho.jpg"></p><p><span style="color: red"> (注意)<br>Application Gateway と App Service 間で HTTPS プロトコルを使用する場合、カスタム ドメインの証明書を App Service 側にも設定する必要がありますのでご留意ください。また、作成した asuid の DNS レコードは WebApps 側のカスタム ドメインの設定後は不要となりますので、削除頂いても問題ございません。</span></p><h3 id="2-Application-Gateway-側で-HTTP-設定とカスタム-プローブの変更"><a href="#2-Application-Gateway-側で-HTTP-設定とカスタム-プローブの変更" class="headerlink" title="2. Application Gateway 側で HTTP 設定とカスタム プローブの変更"></a>2. Application Gateway 側で HTTP 設定とカスタム プローブの変更</h3><p>次に Application Gateway 側の設定を変更します。</p><p>1）    管理ポータルより、正常性プローブを選択し、以下のように変更し保存します<br>    ※下記以外はそのままの設定で問題ありません</p><p>・    ホスト： カスタム ドメイン<br>・    ホスト名をバックエンド HTTP 設定から選択します：いいえ</p><p><img src="/blog/network/appgw-appservice-redirectissue/06.jpg"></p><p>2）    HTTP 設定にて 「新しいホスト名でオーバーライドする」 で いいえ にチェックをいれ保存します<br>※カスタム プローブは １）で変更したものが紐づいている状態となります（ホスト名の箇所でカスタム ドメインを入れても問題ありません）</p><p><img src="/blog/network/appgw-appservice-redirectissue/07.png"></p><p><span style="color: red">(注意)<br> V2 を利用する場合、この変更により Application Gateway - App Service 間で HTTPS プロトコルを使用する場合にライブトラフィックおよびプローブで利用される証明書はカスタム ドメインの証明書となります。バックエンド側に登録したカスタム ドメイン用の証明書が自己署名証明書など、公的機関から発行されていない場合、Application Gateway の HTTP 設定でルート証明書をアップロードする必要があります。</span> ※この動作ついては <a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview#end-to-end-tls-with-the-v2-sku">こちら</a> のドキュメントをご確認ください。</p><h3 id="3-動作の確認"><a href="#3-動作の確認" class="headerlink" title="3. 動作の確認"></a>3. 動作の確認</h3><p>設定は以上です。最後に再度意図した動作となっているかどうかご確認します。<br>再度クライアントから Application Gateway にアクセスした際の F12 のログを確認すると Location ヘッダーの内容がカスタム ドメインとなっていることが確認できます。</p><p><img src="/blog/network/appgw-appservice-redirectissue/08.png"></p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="すでにApplication-Gateway-に向けているカスタムドメインと同じものを-App-Service-に登録することは可能ですか"><a href="#すでにApplication-Gateway-に向けているカスタムドメインと同じものを-App-Service-に登録することは可能ですか" class="headerlink" title="-  すでにApplication Gateway に向けているカスタムドメインと同じものを App Service に登録することは可能ですか"></a>-  すでにApplication Gateway に向けているカスタムドメインと同じものを App Service に登録することは可能ですか</h4><p> はい、可能です。App Service 側ではあくまで 「そのカスタムドメインを受け入れる構成にするために登録する」 ことが目的であり、この登録する際に一時的に該当のドメインを所有しているかどうかの検証があるため、ドメインを管理している DNS 側での設定作業が必要となります。この作業が終われば、App Service の設定は DNS から削除しても問題ありません。実際にカスタム ドメインが名前解決した結果得られる IP アドレスは Application Gateway の IP となることが想定です。</p><h4 id="Azure-Front-Door-のバックエンドに-App-Service-を構成している場合でも同じ事象がおきますか"><a href="#Azure-Front-Door-のバックエンドに-App-Service-を構成している場合でも同じ事象がおきますか" class="headerlink" title="- Azure Front Door のバックエンドに App Service を構成している場合でも同じ事象がおきますか"></a>- Azure Front Door のバックエンドに App Service を構成している場合でも同じ事象がおきますか</h4><p> はい、起きる可能性があります。本Blog にてご紹介した App Service のリダイレクトの問題であると判断できた場合、Azure Front Door のバックエンドの構成で「バックエンド ホスト ヘッダー」の箇所にカスタム ドメインを設定することで対応可能です。</p><p><img src="/blog/network/appgw-appservice-redirectissue/09.png"></p><p><span id="reference"></span></p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h2><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-web-tutorial-custom-domain?tabs=cname#map-your-domain">チュートリアル:既存のカスタム DNS 名を Azure App Service にマップする</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview">Application Gateway での TLS 終了とエンド ツー エンド TLS の概要</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの大塚です。&lt;/p&gt;
&lt;p&gt;この記事では Application Gateway と App Service を組み合わせた時によくお問い合わせをいただくリダイレクトの問題についてご紹介させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>既存 VM の OS ディスクのリソース名を変更する</title>
    <link href="https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/"/>
    <id>https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/</id>
    <published>2021-09-10T00:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.536Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チーム、インターン生の藤澤です。</p><p>Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。<br>本記事では、既存 VM の OS ディスクのリソース名を変更する手順について紹介します。</p><span id="more"></span><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>手順としては、大きく 3 つの作業を実施します。<br>Windows VM、Linux VM ともに同様の手順となります。</p><ol><li>OS ディスクのスナップショットを作成する</li><li>スナップショットから管理ディスクを作成する</li><li>元の OS ディスクと 2 のディスクを入れ替える (スワップする)</li><li>VM の動作確認をする</li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順は、<strong>ARM デプロイ モデル</strong> の VM にて、<strong>管理ディスク</strong> をご利用いただいていることを前提としています。</p><p>　</p><p>スナップショットを取得する際、OS ディスクのスワップを行う際には、<strong>VM が停止済み (割り当て解除)</strong> 状態である必要があります。ダウンタイムが発生するため、業務影響の少ない時間帯にご実施ください。</p></div><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-OS-ディスクのスナップショットを作成する"><a href="#1-OS-ディスクのスナップショットを作成する" class="headerlink" title="1. OS ディスクのスナップショットを作成する"></a>1. OS ディスクのスナップショットを作成する</h3><ol><li><p>Azure Portal の上部検索バーから、[Virtual Machines] で検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/01.png"></p></li><li><p>対象の VM を選択します。<br>対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。<br><img src="/blog/vm/how-to-change-os-disk-name/02.png"></p></li><li><p>画面左下の [ディスク] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/03.png"></p></li><li><p>OS ディスク (リソース名を変更するディスク) を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/04.png"></p></li><li><p>[スナップショットの作成] をクリックします。<br><img src="/blog/vm/how-to-change-os-disk-name/05.png"></p></li><li><p>必要事項を入力後、[作成] を選択します。</p><blockquote><p>ご参考：Azure リソースの名前付け規則と制限事項 - Microsoft.Compute<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules#microsoftcompute">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules#microsoftcompute</a><br>参照箇所：disks</p></blockquote><p><img src="/blog/vm/how-to-change-os-disk-name/06.png"></p></li></ol><h3 id="2-スナップショットから管理ディスクを作成する"><a href="#2-スナップショットから管理ディスクを作成する" class="headerlink" title="2. スナップショットから管理ディスクを作成する"></a>2. スナップショットから管理ディスクを作成する</h3><ol><li><p>Azure Portal の上部検索バーで [スナップショット] と検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/07.png"></p></li><li><p>作成したスナップショット (手順 1 ~ 6) を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/08.png"></p></li><li><p>[ディスクの作成] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/09.png"></p></li><li><p>必要項目を適宜入力し、[確認および作成] をクリックします。<br> 変更後の OS ディスク名は、”ディスクの詳細” の “ディスク名” で任意の値を入力してください。<br> <img src="/blog/vm/how-to-change-os-disk-name/10.png"></p></li></ol><h3 id="3-元の-OS-ディスクと-2-のディスクを入れ替える-スワップする"><a href="#3-元の-OS-ディスクと-2-のディスクを入れ替える-スワップする" class="headerlink" title="3. 元の OS ディスクと 2 のディスクを入れ替える (スワップする)"></a>3. 元の OS ディスクと 2 のディスクを入れ替える (スワップする)</h3><p>※ VM が停止済み (割り当て解除) 状態である必要があります。<br>※ 対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。</p><ol><li><p>Azure Portal の上部検索バーから、[Virtual Machines] で検索します。<br><img src="/blog/vm/how-to-change-os-disk-name/01.png"></p></li><li><p>対象の VM を選択します。<br>対象 VM が起動している場合には [停止] をクリックし、”停止済み (割り当て解除)” 状態となっていることを確認します。<br><img src="/blog/vm/how-to-change-os-disk-name/02.png"></p></li><li><p>画面左下の [ディスク] を選択します。<br><img src="/blog/vm/how-to-change-os-disk-name/03.png"></p></li><li><p>[OS ディスクのスワップ] をクリックします。<br> <img src="/blog/vm/how-to-change-os-disk-name/13.png"></p></li><li><p>作成したディスクを選択します。<br> <img src="/blog/vm/how-to-change-os-disk-name/14.png"></p></li><li><p>ディスクのリソース名が反映されているか確認します。<br> VM を起動・接続し、問題なく動作することをご確認ください。<br> <img src="/blog/vm/how-to-change-os-disk-name/15.png"></p></li></ol><h3 id="4-VM-の動作確認をする"><a href="#4-VM-の動作確認をする" class="headerlink" title="4. VM の動作確認をする"></a>4. VM の動作確認をする</h3><p>OS ディスクのスワップが完了した後には、念のため VM が正しく動作すること (ゲスト OS が起動し、アプリケーション等の動作に問題がないこと) をご確認ください。</p><ol><li><p>VM を起動します。</p></li><li><p>VM に接続し、正しく動作することを確認します。</p></li><li><p>必要に応じてスワップ後の元ディスクを削除します。</p></li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>管理ディスクは、使用するディスク領域の量に関係なく、作成したディスクの種類に応じて固定料金で課金されます。</p><p>上記手順を実施いただいた後は、必要に応じて元ディスクを削除してください。</p><p>　</p><p><strong>ご参考</strong></p><p>・<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-types">Azure IaaS VM 用のディスクの種類の選択</a>)</p><p>・<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">Managed Disks の価格</a></p></div><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チーム、インターン生の藤澤です。&lt;/p&gt;
&lt;p&gt;Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。&lt;br&gt;本記事では、既存 VM の OS ディスクのリソース名を変更する手順について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>VM 作成時に OS ディスク名を指定する方法について</title>
    <link href="https://jpaztech.github.io/blog/vm/set-os-disk-name-using-arm-template/"/>
    <id>https://jpaztech.github.io/blog/vm/set-os-disk-name-using-arm-template/</id>
    <published>2021-09-09T05:02:00.000Z</published>
    <updated>2021-12-07T12:35:26.596Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの西澤です。</p><p>Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。<br>本記事では、ARM テンプレートを使用して VM 作成時に OS ディスクのリソース名を変更する手順についてご紹介します。</p><span id="more"></span><p>既存の VM の OS ディスクのリソース名を変更する手順については、ブログ <a href="https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/">既存 VM の OS ディスクのリソース名を変更する</a> に記載されていますので、併せてご確認いただけますと幸いです。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>下記の手順で OS ディスク名を指定の上、VM をデプロイいたします。<br>Windows VM、Linux VM ともに同様の手順となります。</p><ol><li>Azure Portal より ARM テンプレートを用意する</li><li>OS ディスクの名前を設定する</li><li>VM をデプロイする </li><li>確認</li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順は、ARM デプロイ モデル の VM にて、管理ディスク をご利用いただいていることを前提としています。</p></div><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h2 id="1-Azure-Portal-より-ARM-テンプレートを用意する"><a href="#1-Azure-Portal-より-ARM-テンプレートを用意する" class="headerlink" title="1. Azure Portal より ARM テンプレートを用意する"></a>1. Azure Portal より ARM テンプレートを用意する</h2><p>Azure ポータルより [Virtual Machines] を開き、VM の新規作成画面を開きます。<br>必要な項目を設定し、画面下部にある [確認および作成] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/1.png"></p><p>検証が完了しましたら、画面下部にある [Automation のテンプレートをダウンロードする] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/2.png"></p><p>表示された ARM テンプレートを使用して VM をデプロイするため、[デプロイ] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/3.png"></p><p>ARM テンプレートを使用したカスタム デプロイの画面へ遷移しましたら、テンプレートを編集するため、<br>[テンプレートの編集] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/4.png"></p><h2 id="2-OS-ディスクの名前を設定する"><a href="#2-OS-ディスクの名前を設定する" class="headerlink" title="2. OS ディスクの名前を設定する"></a>2. OS ディスクの名前を設定する</h2><p>ARM テンプレート内の下記箇所を追記して、OS ディスクの名前を編集します。<br>編集が完了しましたら、画面下部にある [保存] を選択します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;resources&quot;: [&#123;</span><br><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">&quot;storageProfile&quot;: &#123;</span><br><span class="line">&quot;osDisk&quot;: &#123;</span><br><span class="line">&quot;name&quot;: &quot;ここにご希望の OS ディスクの名前を記入します&quot;,</span><br></pre></td></tr></table></figure><div class="alert is-warning"><p class="alert-title">警告</p><p>最後の「,」の付け忘れにご注意ください。</p></div><p><img src="/blog/vm/set-os-disk-name-using-arm-template/5.png"></p><p>ARM テンプレートのパラメータに関する詳細内容に関しましては<br>下記の弊社公式ドキュメントをご参照ください。</p><blockquote><p>ご参考：Azure Resource Manager テンプレートの仮想マシン<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/template-description">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/template-description</a></p></blockquote><h2 id="3-VM-をデプロイする"><a href="#3-VM-をデプロイする" class="headerlink" title="3. VM をデプロイする"></a>3. VM をデプロイする</h2><p>必要な項目を設定し、画面下部にある  [確認と作成] を選択します。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/6.png"></p><p>検証が正常に完了しましたら、[作成] を押してデプロイください。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/7.png"></p><h2 id="4-確認"><a href="#4-確認" class="headerlink" title="4. 確認"></a>4. 確認</h2><p>デプロイが完了したら、Azure Portal からデプロイした Virtual Machine を選択し、[ディスク] を選択ください。<br>OS ディスクの名前が設定した名前となっていることをご確認いただければ完了です。</p><p><img src="/blog/vm/set-os-disk-name-using-arm-template/8.png"></p><hr><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの西澤です。&lt;/p&gt;
&lt;p&gt;Azure VM を作成いただく際、OS ディスクのリソース名は自動で生成されますが、リソース管理の都合上、この OS ディスクのリソース名を任意の名前に変更したいというお問い合わせをいただくことがあります。&lt;br&gt;本記事では、ARM テンプレートを使用して VM 作成時に OS ディスクのリソース名を変更する手順についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="ARM" scheme="https://jpaztech.github.io/blog/tags/ARM/"/>
    
    <category term="Managed Disk" scheme="https://jpaztech.github.io/blog/tags/Managed-Disk/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
    <category term="How To" scheme="https://jpaztech.github.io/blog/tags/How-To/"/>
    
  </entry>
  
  <entry>
    <title>VM の再作成により可用性ゾーンを変更する (Azure ポータル編)</title>
    <link href="https://jpaztech.github.io/blog/vm/change-availability-zone-from-portal/"/>
    <id>https://jpaztech.github.io/blog/vm/change-availability-zone-from-portal/</id>
    <published>2021-08-11T09:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.468Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの松岡です。</p><p>VM における可用性ゾーンの利用有無は、VM を新規作成する場合にのみ設定することができますが、運用をしている中で VM を可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいという状況もあるかと思います。<br>本稿では、そのような際、VM の可用性ゾーンを変更する方法について、Azure ポータルからの実施方法をご案内します。</p><span id="more"></span><p>なお、Azure ポータルからではなく Azure PowerShell を用いた実施方法を確認する場合は、以下の記事をご確認ください。</p><blockquote><p>VM の再作成により可用性ゾーンを変更する (PowerShell 編)<br><a href="https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/">https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/</a></p></blockquote><p>また、可用性ゾーンをサポートしているのは一部リージョンのみとなりますので、ご留意ください。</p><blockquote><p>Azure での Availability Zones をサポートしているリージョン<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region">https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region</a></p></blockquote><hr><h2 id="■-手順を利用する前提条件"><a href="#■-手順を利用する前提条件" class="headerlink" title="■ 手順を利用する前提条件"></a>■ 手順を利用する前提条件</h2><p>本手順では、管理ディスクを利用していることを前提としてご案内します。</p><hr><h2 id="■-手順の流れについて"><a href="#■-手順の流れについて" class="headerlink" title="■ 手順の流れについて"></a>■ 手順の流れについて</h2><p>VM の可用性ゾーンを変更する場合、以下の流れにて作業を行います。</p><ol><li>VM を停止 (割り当て解除) する</li><li>ディスクのスナップショットを作成する</li><li>ディスクのスナップショットから新規にディスクを作成する</li><li>新規に作成したディスクから VM を作成する</li><li>作成したスナップショット、および元々利用していたリソースを削除する</li></ol><p>本稿では、VM の可用性ゾーンを 1 から 2 に変更する手順を例として紹介します。</p><hr><h2 id="■-VM-の可用性ゾーンを変更する手順"><a href="#■-VM-の可用性ゾーンを変更する手順" class="headerlink" title="■ VM の可用性ゾーンを変更する手順"></a>■ VM の可用性ゾーンを変更する手順</h2><h3 id="1-VM-を停止-割り当て解除-する"><a href="#1-VM-を停止-割り当て解除-する" class="headerlink" title="1. VM を停止 (割り当て解除) する"></a>1. VM を停止 (割り当て解除) する</h3><p>Azure ポータルより [Virtual Machines] - [&lt;当該 VM 名&gt;] を開き、VM を停止 (割り当て解除) します。<br>VM の状態が [停止済み (割り当て解除)] になっていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/1.png"></p><p>左メニュー “設定” より [ディスク] を選択し、開いた画面 “OS ディスク” より [&lt;当該 OS ディスク名&gt;] をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/2.png"></p><h3 id="2-ディスクのスナップショットを作成する"><a href="#2-ディスクのスナップショットを作成する" class="headerlink" title="2. ディスクのスナップショットを作成する"></a>2. ディスクのスナップショットを作成する</h3><p>画面の “＋ スナップショットの作成” をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/3.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>“記憶域の種類” は、スナップショットを高パフォーマンスのディスクに保存する必要がある場合を除き、 [Standard_HDD] を選択します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/4.png"></p><p>データディスクがある場合、データディスクについても同様にスナップショットを作成します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/5.png"></p><h3 id="3-ディスクのスナップショットから新規にディスクを作成する"><a href="#3-ディスクのスナップショットから新規にディスクを作成する" class="headerlink" title="3. ディスクのスナップショットから新規にディスクを作成する"></a>3. ディスクのスナップショットから新規にディスクを作成する</h3><p>Azure ポータル 上部の検索バーに “スナップショット” と入力し、サービス [スナップショット] を選択します。<br>上記手順で作成した OS ディスクおよび、データ ディスクのスナップショットが作成されていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/6.png"></p><p>OS ディスクのスナップショットを選択し、[+ ディスクの作成] をクリックします。</p><p><img src="/blog/vm/change-availability-zone-from-portal/7.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>可用性ゾーンを希望のゾーン番号に変更します。<br>こちらの手順では、元々選択していた “1” から “2” へとゾーンを変更しています。</p><p><img src="/blog/vm/change-availability-zone-from-portal/8.png"></p><p>データ ディスクについても同様にディスクを作成します。</p><h3 id="4-新規に作成したディスクから-VM-を作成する"><a href="#4-新規に作成したディスクから-VM-を作成する" class="headerlink" title="4. 新規に作成したディスクから VM を作成する"></a>4. 新規に作成したディスクから VM を作成する</h3><p>Azure ポータル上部の検索バーに “ディスク” と入力し、サービス [ディスク] を選択します。<br>上記手順で作成した OS ディスクおよび、データ ディスクが作成されていることを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/9.png"></p><p>作成した OS ディスクを選択し、[+ VM の作成] をクリックします。<br>表示されているディスクの状態が “Unattached”、可用性ゾーンが指定した番号であるかを確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/10.png"></p><p>必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>可用性ゾーンの番号は、作成したディスクと同じ番号を指定します。<br>データ ディスクは [既存のディスクの接続] より、スナップショットから作成したデータ ディスクを適宜選択します。<br>VNET は同様に既存のものから選択出来ますが、NIC は新規に作成されます。</p><p><img src="/blog/vm/change-availability-zone-from-portal/11.png"></p><p>作成された VM が、指定のゾーン番号で表示されていること(こちらの手順ではゾーン “2” )を確認します。</p><p><img src="/blog/vm/change-availability-zone-from-portal/12.png"></p><h3 id="5-作成したスナップショット、および元々利用していたリソースを削除する"><a href="#5-作成したスナップショット、および元々利用していたリソースを削除する" class="headerlink" title="5. 作成したスナップショット、および元々利用していたリソースを削除する"></a>5. 作成したスナップショット、および元々利用していたリソースを削除する</h3><p>作成した VM が正常動作することを確認後、元々利用していたリソース、および元々利用していたリソースを削除し、手順は完了です。</p><hr><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの松岡です。&lt;/p&gt;
&lt;p&gt;VM における可用性ゾーンの利用有無は、VM を新規作成する場合にのみ設定することができますが、運用をしている中で VM を可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいという状況もあるかと思います。&lt;br&gt;本稿では、そのような際、VM の可用性ゾーンを変更する方法について、Azure ポータルからの実施方法をご案内します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure VPN ゲートウェイにメンテナンスがあったか確認する方法</title>
    <link href="https://jpaztech.github.io/blog/network/vpngw-how-to-check-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/vpngw-how-to-check-maintenance/</id>
    <published>2021-07-27T15:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.400Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームです。<br>今回は、Azure でお使いいただいている VPN ゲートウェイにおいて、メンテナンスが行われていたことを事後確認する方法をご紹介します。<br>今回ご紹介する内容については以下の前提条件の下記載されておりますので予めご了承ください。</p><p><strong>前提</strong></p><ul><li>メンテナンスの日時を事前に確認する方法ではなく、あくまで事後に確認する方法になります。</li><li>VPN ゲートウェイに対する全てのメンテナンスを対象としてはおらず、種類によってはお客様自身でメンテナンスの形跡をご確認をいただけない場合もあります。</li></ul><p><strong>目次</strong>  </p><ul><li>はじめに  </li><li>診断ログとは  </li><li>診断ログ設定の事前準備  </li><li>診断ログの設定方法  </li><li>診断ログよりメンテナンスの形跡を確認する方法  </li><li>最後に  </li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure の サイト間 VPN (S2S VPN) をご利用いただいているお客様より、一時的に S2S VPN の切断が発生したというお問い合わせをいただくことがあります。<br>インターネットを経由して接続される S2S VPN の切断は様々な要因によって発生致しますが、VPN ゲートウェイに対して行われるメンテナンスもその主たる要因の一つです。<br>VPN ゲートウェイでは健全なサービス運用及び品質維持のため、不定期にメンテナンスが行われ、この作業は数十秒から数分程度の一時的な S2S VPN の切断を伴う場合があります。<br>VPN ゲートウェイに対するメンテナンスについては事前通知が行われておらず、残念ながら計画された予定を把握いただくことはできません。<br>一方で、ご利用いただいている S2S VPN において一時的な切断を検知する度に、それがメンテナンスによるものか否かをサポートにお問い合わせいただくのは、大変お手間かと思います。  </p><p>そこで今回は、お客様自身で VPN ゲートウェイにメンテナンスが行われたことを確認する方法をご紹介いたします。<br>VPN ゲートウェイのメンテナンスには多岐にわたる種類があり、全てのメンテナンスを事後確認できるわけではないのですが、一部でもお客様自身でご確認をいただければご負担も減ると思いますのでご一読ください。</p><h2 id="診断ログとは"><a href="#診断ログとは" class="headerlink" title="診断ログとは"></a>診断ログとは</h2><p>VPN ゲートウェイのメンテナンスの形跡を確認するためには、対象のリソースに対して診断ログという機能を有効にします。<br>診断ログは Azure で提供される様々なサービスにおいて利用することが可能で、主に特定のリソースに関わるイベントや、そのリソースの状態を表す情報をログとして取得する機能です。<br>VPN ゲートウェイで取得できる診断ログには下記の様に複数の種類があり、欲しい情報に応じてどのログを取得するかを選択できます(複数種類のログを取得することも可能です)。  </p><ul><li><strong>GatewayDiagnosticLog</strong><br>ゲートウェイ構成イベント、主要な変更、メンテナンス イベントのリソース ログが含まれています。</li><li><strong>TunnelDiagnosticLog</strong><br>トンネルの状態変更イベントが含まれています。 トンネルの接続/切断イベントには、状態変更の理由の概要があります (該当する場合)。</li><li><strong>RouteDiagnosticLog</strong><br>ゲートウェイで発生する静的ルートへの変更および BGP イベントがログに記録されます。</li><li><strong>IKEDiagnosticLog</strong><br>ゲートウェイ上の IKE コントロールのメッセージおよびイベントがログに記録されます。</li><li><strong>P2SDiagnosticLog</strong><br>ゲートウェイ上のポイント対サイト コントロールのメッセージおよびイベントがログに記録されます。 接続ソース情報は IKEv2 接続に対してのみ提供されます。</li></ul><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log">VPN Gateway からのリソース ログ イベントにアラートを設定する</a></p><p>ご覧の通り VPN ゲートウェイ自身や S2S VPN / P2S VPN接続に関する様々な情報を取得できる診断ログですが、今回の主題であるメンテナンスの確認には、 “GatewayDiagnosticLog” という種類のログを使用します。</p><h2 id="診断ログ設定の事前準備"><a href="#診断ログ設定の事前準備" class="headerlink" title="診断ログ設定の事前準備"></a>診断ログ設定の事前準備</h2><p>診断ログは、設定時に指定したサービスに出力され、その内容を確認することができます。<br>出力先には、Log Analytics ワークスペース、ストレージアカウント、及びイベントハブが指定可能です。<br>これらの出力先を複数指定する(例えば Log Analytics ワークスペースに診断ログを出力しつつ、ストレージアカウントにも保存する)ことも可能ですが、今回は検索のし易さや出力結果の可読性を考慮して Log Analytics ワークスペースを出力先に指定する手順をご紹介します。</p><p>診断ログを設定する前に、出力先として指定する Log Analytics ワークスペースを作成しておく必要があります。<br>Log Analytics ワークスペースの作成方法は、以下の通りです。</p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「Log Analytics ワークスペース」という項目を選択します。</li><li>「Log Analytics ワークスペース」の画面で「＋ 追加」を選択します。</li><li> Log Analytics ワークスペースの作成画面にて、サブスクリプションとリソースグループ、リソースの名称及びリージョンを指定します。</li></ol><p>(Log Analytics ワークスペース作成画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/create-log-analytics-workspace.png"></p><p>上記の手順はこちらのドキュメントで紹介されている手順 1 から手順 3 までの部分に該当致しますので、併せてご確認ください。</p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp//azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log#set-up-alerts-in-the-azure-portal">Azure portal でアラートを設定する</a></p><h2 id="診断ログの設定方法"><a href="#診断ログの設定方法" class="headerlink" title="診断ログの設定方法"></a>診断ログの設定方法</h2><p>Log Analytics ワークスペースの作成が完了しましたので、次に仮想ネットワークゲートウェイの診断ログを設定します。<br>具体的な診断ログの設定方法は、以下の通りです。  </p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「モニター」という項目を選択します。</li><li>「モニター」の画面で左側のペインより「診断設定」を選択します。</li><li>「診断設定」の画面にて、サブスクリプションとリソースグループを指定し、対象の VPN ゲートウェイ(仮想ネットワークゲートウェイ)を選択します。</li><li>「+ 診断設定を追加する」を選択します。</li><li>診断ログ設定自体の名称を設定し、取得したいログ(今回は最低限 “GatewayDiagnosticLog” )にチェックを入れ、出力先を指定し保存します。</li></ol><p>(診断ログ設定画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/diag-setting.png"></p><p>上記の手順はこちらのドキュメントで紹介されている手順 4 から手順 6 までの部分に該当致します。<br>Azure ポータルのスクリーンショット情報もあるので、よこちらもご参照ください。  </p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp//azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log#set-up-alerts-in-the-azure-portal">Azure portal でアラートを設定する</a></p><p>なお、診断ログは設定を行った以後より取得が行われるため、設定を行う以前のログを遡って確認することはできない点予めご了承ください。<br>また、診断ログの設定後、実際にログの情報が取得開始されるまでには数時間程度かかる場合がございます。</p><h2 id="診断ログよりメンテナンスの形跡を確認する方法"><a href="#診断ログよりメンテナンスの形跡を確認する方法" class="headerlink" title="診断ログよりメンテナンスの形跡を確認する方法"></a>診断ログよりメンテナンスの形跡を確認する方法</h2><p>診断ログを有効化したら、 VPN ゲートウェイにおけるメンテナンスの形跡を確認する準備が整いました。<br>ここで、先の手順で診断ログの出力先に指定した Log Analytics ワークスペースより、メンテナンスの形跡を含む内容があるかを確認してみます。</p><ol><li>Azure ポータルより「すべてのサービス」を選択します。</li><li>「モニター」のカテゴリより、「Log Analytics ワークスペース」という項目を選択します。</li><li>診断ログの出力先として指定した Log Analytics ワークスペースを選択します。</li><li>「Log Analytics ワークスペース」の画面で左側のペインより「ログ」を選択します。</li><li>クエリの入力欄診断ログの内容を検索するクエリを入力の上、「時間の範囲」を S2S VPN 切断を検知した時間帯を含む値に設定し「実行」を押下します。</li></ol><p>(Log Analytics ワークスペース　クエリ実行画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/log-analytics-workspace-query.png"></p><p>入力するクエリの具体例として、下記を Log Analytics ワークスペース上で実行いただくことで、メンテナンスの情報を含む “GatewayDiagnosticLog” の内容を検索することが可能です。<br>このクエリで条件として指定している OperationName == “HostMaintenanceEvent” という部分が、メンテナンスの形跡を示すものです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>上記クエリの実行結果に該当する診断ログが見られる場合、メンテナンスが発生したと判断できます。<br>その場合、以下の画像のように “OperationName “ フィールドが “HostMaintenanceEvent” である実行結果が確認できます。  </p><p>(Log Analytics ワークスペース　クエリ実行結果画面例)<br><img src="/blog/network/vpngw-how-to-check-maintenance/HostMaintenanceEvent.png"></p><p>なお、診断ログの内容を検索するためのクエリについては、お客様自身で適宜カスタマイズいただくことができます。<br>例えば複数の VPN ゲートウェイで診断ログを取得しているような環境で、リソース名で対象をフィルターしたい場合には、下記のように “Resource” フィールドを追加してください。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| where Resource == &quot;VPNGW01&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>その他、診断ログを検索する期間については Azure ポータル上からも設定できますが、クエリで日付や時間帯を指定したい場合は “TimeGenerated” フィールドでフィルターすることも可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where TimeGenerated &gt; datetime(&quot;2021/04/27T04:00:00&quot;) and TimeGenerated &lt; datetime(&quot;2021/04/27T06:00:00&quot;)</span><br><span class="line">| where Category == &quot;GatewayDiagnosticLog&quot;</span><br><span class="line">| where OperationName == &quot;HostMaintenanceEvent&quot;</span><br><span class="line">| project TimeGenerated, Resource, OperationName, Message</span><br></pre></td></tr></table></figure><p>このように、 S2S VPN の接続断を検知した時間帯付近の診断ログの内容を確認することで、お客様ご自身で迅速にメンテナンスの形跡を確認できますので是非ご活用ください。<br>もし今回ご紹介した方法を用いてもメンテナンスの形跡を確認できず、なおかつ S2S VPN の対向側となるお客様環境にも問題が見受けられない場合には、お気兼ねなく Azure サポートまでお問い合わせください。  </p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>最後に、メンテナンスの事後確認とは別の観点でございますが、メンテナンスによる S2S VPN への影響を最小化するために、VPN ゲートウェイを  Active / Active で運用する構成についてもご紹介いたします。</p><p>VPN ゲートウェイは内部的に 2 台インスタンスを所有しており、デフォルトではうち 1 台が Active として稼働している Active /Standby の状態で構成されます。<br>VPN ゲートウェイのメンテナンスはこの 2 台のインスタンスに対して順番に行われ、それに伴いフェイルオーバーが生じます。  </p><p>一方 Active / Active でVPN ゲートウェイを構成した場合、 2 台のインスタンスが同時に Active で稼働するため、常時 2 本の VPN トンネルが構成可能です。<br>片方のインスタンスにメンテナンスが行われている間も、もう片方のインスタンスと構成している VPN トンネルが維持されることから、メンテナンス時におけるエンドツーエンドの接続性への影響を軽減できます。  </p><p>VPN ゲートウェイの Active / Active 構成については以下ドキュメントにも記載がございますので、ご参照ください。  </p><p>(ご参考)<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-highlyavailable">高可用性のクロスプレミス接続および VNet 間接続</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームです。&lt;br&gt;今回は、Azure でお使いいただいている VPN ゲートウェイにおいて、メンテナンスが行われていたことを事後確認する方法をご紹介します。&lt;br&gt;今回ご紹介する内容については以下の前提条件の下記載されておりますので予めご了</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway 設定変更の影響</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-configchange/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-configchange/</id>
    <published>2021-07-05T05:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.388Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの杜です。</p><p>Application Gateway に設定変更を行う際に既存接続(TCP コネクション)への影響についてご紹介させて頂きます。<br>SKU により動作が異なっていますので、以下にて各 SKU の詳細をご説明します。</p><h2 id="Application-Gateway-SKU-Standard-v1-amp-WAF-v1"><a href="#Application-Gateway-SKU-Standard-v1-amp-WAF-v1" class="headerlink" title="Application Gateway SKU Standard_v1 &amp; WAF_v1"></a>Application Gateway SKU Standard_v1 &amp; WAF_v1</h2><h3 id="設定変更の影響"><a href="#設定変更の影響" class="headerlink" title="設定変更の影響"></a>設定変更の影響</h3><p>基本的には既存接続に影響するような設定変更をしない限り影響はありません。</p><p>例えば、１つの Application Gateway に以下の設定が入っている場合は</p><ul><li>リスナー A → 要求ルーティング A → HTTP設定 A → バックエンド プール A, カスタム正常性プローブ A</li><li>リスナー B → 要求ルーティング B → HTTP設定 B → バックエンド プール B, カスタム正常性プローブ B</li></ul><p>任意の設定 A に対する設定変更、もしくは新規設定を追加してもリスナー B への既存接続に影響しません。</p><h3 id="影響がある場合の動作"><a href="#影響がある場合の動作" class="headerlink" title="影響がある場合の動作"></a>影響がある場合の動作</h3><p>既存接続が使用している設定を変更する場合、Application Gateway から クライアントに対して <strong>TCP RST</strong> を送信する動作だと確認しています。</p><p>例えば、リスナー A が使用している証明書を更新しますと、パケット キャプチャにて以下の動作が確認しています。</p><p>クライアント IP 192.168.0.172<br>Application Gateway パブリック IP 20.48.x.x</p><p><img src="./v1_rst.png"></p><blockquote><p>パケット レベルの詳細動作について現時点では公開ドキュメントに記載されておらず、保証される動作わけではございませんので、予めご了承ください。</p></blockquote><h2 id="Application-Gateway-SKU-Standard-v2-amp-WAF-v2"><a href="#Application-Gateway-SKU-Standard-v2-amp-WAF-v2" class="headerlink" title="Application Gateway SKU Standard_v2 &amp; WAF_v2"></a>Application Gateway SKU Standard_v2 &amp; WAF_v2</h2><h3 id="設定変更の影響-1"><a href="#設定変更の影響-1" class="headerlink" title="設定変更の影響"></a>設定変更の影響</h3><p>基本的には全般の作業がすべての既存接続に影響を与えます。<br>たとえ関連しない新規設定を追加するだけでも、既存すべてのリスナーへの TCP 接続が切断される動作となります。</p><p>例えば、１つの Application Gateway に以下の設定が入っている場合は</p><ul><li>リスナー A → 要求ルーティング A → HTTP設定 A → バックエンド プール A, カスタム正常性プローブ A</li><li>リスナー B → 要求ルーティング B → HTTP設定 B → バックエンド プール B, カスタム正常性プローブ B</li></ul><p>任意の設定 A か B に対する設定変更、もしくは新規の HTTP 設定やバックエンド プールを追加しますと、リスナー A 及び B への既存接続が切断されます。</p><h3 id="影響がある場合の動作-1"><a href="#影響がある場合の動作-1" class="headerlink" title="影響がある場合の動作"></a>影響がある場合の動作</h3><p>任意の設定が変更される場合は、Application Gateway から クライアントに対して <strong>TCP FIN</strong> を送信する動作だと確認しています。</p><p>例えば、リスナー A が使用している証明書を更新しますと、パケット キャプチャにて以下の動作が確認しています。</p><p>クライアント IP 192.168.0.172<br>Application Gateway パブリック IP 20.48.x.x</p><p><img src="./v2_fin.png"></p><blockquote><p>パケット レベルの詳細動作について現時点では公開ドキュメントに記載されていなく、保証される動作わけではございませんので、予めご了承ください。</p></blockquote><h2 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h2><h2 id="TCP-コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？"><a href="#TCP-コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？" class="headerlink" title="TCP コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？"></a>TCP コネクションが切断されますが、実際にクライアントに対してどんな影響されますか？</h2><p>クライアントの接続設定と挙動により一概にご案内できませんが、例えば Chrome などのブラウザが再接続などによって基本的には瞬断以外の影響はないと思われますが、<br>もし少しの切断も許されないような環境でご利用の場合、メンテナンスの時間帯を設置して Application Gateway の設定変更をご実施頂きますようお願い致します。</p><h3 id="設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？"><a href="#設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？" class="headerlink" title="設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？"></a>設定変更してから既存接続が切断されるまでどのぐらい時間かかりますか？</h3><p>Azure 基盤側の処理状況によって固定ではありませんが、数十秒から数分間かかる場合は多いと見受けられます。<br>Azure ポータルから設定変更した場合は、下記のような設定変更の通知が出た後、数十秒後に接続済みの TCP コネクションが Application Gateway 側よりクローズされる動作を確認しています。<br><img src="./v2_notification.png"></p><h3 id="Application-Gateway-v2-が-KeyVault-と連携している場合では、Key-Vault-側で証明書を更新した際にも同じように瞬断などの影響を受けますか？"><a href="#Application-Gateway-v2-が-KeyVault-と連携している場合では、Key-Vault-側で証明書を更新した際にも同じように瞬断などの影響を受けますか？" class="headerlink" title="Application Gateway v2 が KeyVault と連携している場合では、Key Vault 側で証明書を更新した際にも同じように瞬断などの影響を受けますか？"></a>Application Gateway v2 が KeyVault と連携している場合では、Key Vault 側で証明書を更新した際にも同じように瞬断などの影響を受けますか？</h3><p>以下の公開ドキュメントに記載されている通り、KeyVault と連携した場合は証明書更新が検出されると Application Gateway に自動的に反映する動作となります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/key-vault-certs">Key Vault 証明書を使用した TLS 終端</a></li></ul><blockquote><p>インスタンスによって Key Vault が 4 時間間隔でポーリングされ、証明書の更新バージョン (存在する場合) が取得されます。 更新された証明書が検出されると、HTTPS リスナーに現在関連付けられている TLS または SSL 証明書が自動的にローテーションされます。</p></blockquote><p>この時に手動で証明書更新と同様な影響を受けることを確認しています。<br>そのため、既存接続に影響するタイミングをコントロールされたい場合は、証明書は手動更新にして頂きますようにお願い致します。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポートチームの杜です。&lt;/p&gt;
&lt;p&gt;Application Gateway に設定変更を行う際に既存接続(TCP コネクション)への影響についてご紹介させて頂きます。&lt;br&gt;SKU により動作が異なっていますので、以下にて各 SKU の詳細をご説</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure 環境における Windows Server 2016 にて日本語の言語パック適用ができない (修正展開済み)</title>
    <link href="https://jpaztech.github.io/blog/vm/win2016-jp-lpk-issue/"/>
    <id>https://jpaztech.github.io/blog/vm/win2016-jp-lpk-issue/</id>
    <published>2021-06-14T02:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.628Z</updated>
    
    <content type="html"><![CDATA[<span style="color:red;"><p><strong>Update: 2021/6/14</strong> (Last: 5/10)<br>東西日本リージョンに Windows Server 2016 Datacenter の修正版イメージが展開され、修正後のイメージにて、通常通りの手順で言語パックのインストールが可能であることを確認いたしました。<br>その他リージョンにおいて、修正版イメージが展開されているかをご確認いただくには後述のコマンドをご実施ください。</p></span><span id="more"></span><h2 id="ご利用のリージョンにおいて修正版イメージが展開済みであるか確認する"><a href="#ご利用のリージョンにおいて修正版イメージが展開済みであるか確認する" class="headerlink" title="ご利用のリージョンにおいて修正版イメージが展開済みであるか確認する"></a>ご利用のリージョンにおいて修正版イメージが展開済みであるか確認する</h2><p>修正版イメージは、順次展開されています。<br>ご利用のリージョンにおいて、修正版イメージが展開されているかについては、Azure PowerShell コマンドにてご確認いただけます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$locName = &quot;&lt;ご利用のリージョン&gt;&quot;</span><br><span class="line">$pubName = &quot;MicrosoftWindowsServer&quot;</span><br><span class="line">$offerName = &quot;WindowsServer&quot;</span><br><span class="line">$skuName = &quot;2016-datacenter&quot;</span><br><span class="line">$win2016ver = Get-AzVMImage -Location $locName -PublisherName $pubName -Offer $offerName -Sku $skuName | Select Version</span><br><span class="line">$win2016ver | where Version -eq &quot;14393.4467.2106061537&quot;</span><br></pre></td></tr></table></figure><p>適用済みの場合、下記のような実行結果となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Version              </span><br><span class="line">-------              </span><br><span class="line">14393.4467.2106061537</span><br></pre></td></tr></table></figure><hr><h2 id="アーカイブ"><a href="#アーカイブ" class="headerlink" title="アーカイブ"></a>アーカイブ</h2><p>こんにちは。Azure テクニカル サポート チームの大関です。 </p><p>2021 年 4 月より、Azure Market Place の Windows Server 2016 Datacenter イメージに含まれるトランザクションログの肥大化により、ゲスト OS の日本語化が失敗する事象が報告されております。<br>Azure Market Place より新規にデプロイした VM (Windows Server 2016 Datacenter) において、ゲスト OS の日本語化に失敗する事象が発生した事象の場合、こちらに該当している可能性が高いと考えられます。</p><p>本記事では、対処法についてご紹介いたしますので、下記手順をお試しいただき、言語パックの適用が完了するかをご確認ください。</p><p>なお、今回の問題は、Windows 2016 Datacenter イメージ自体の問題の可能性が高く、現在修正を実施しております。今月 (2021 年 5 月) 中には修正完了の予定ではございますが、 もし問題が発生しましたら本対処をご検討いただけますと幸いでございます。 </p><h3 id="対処策：TxR-配下のトランザクション-ログのリセット"><a href="#対処策：TxR-配下のトランザクション-ログのリセット" class="headerlink" title="対処策：TxR 配下のトランザクション ログのリセット"></a>対処策：TxR 配下のトランザクション ログのリセット</h3><p>TxR 配下のトランザクション ログは削除しようとしても、システム稼働時は常にシステム プロセスが参照しているため、削除しようとしてもエラーとなります。<br>このため、”PendMoves と MoveFile” という弊社の無償のサポート ツールを使ってトランザクション ログの削除をご検討ください。 </p><ol><li>“PendMoves と MoveFile” ツールの入手 <ul><li>以下の弊社サイトより “PendMoves.zip” をダウンロードし、解凍します。 </li><li>movefile.exeを対象マシンにコピーします。<br>(※pendmoves.exe は今回は使用いたしません) </li></ul></li></ol><blockquote><p>PendMoves v1.02 and MoveFile v1.01<br><a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/pendmoves">https://docs.microsoft.com/ja-jp/sysinternals/downloads/pendmoves</a> </p></blockquote><ol start="2"><li>attrib コマンドで隠し属性を解除します。<br>コマンド プロンプトを管理者として実行し以下のコマンドを実行します。 </li></ol><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Windows\system32\config\txr </span><br><span class="line"><span class="built_in">attrib</span> -r -s -h * </span><br></pre></td></tr></table></figure><ol start="3"><li><p>CD コマンドで movefile.exe が保存されているディレクトリに移動します。 </p></li><li><p>movefile.exe コマンドで削除するファイルを登録するため、以下を1 行づつ実行してください。<br>※アスタリスクによるファイル指定ができないため、貴社環境に存在するファイルに基づきコマンドをご実施ください。<br>※”&lt;移動先&gt;” を空欄にすることで、次回再起動時にファイルの削除がスケジュールされます。 <br></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">movefile.exe /accepteula &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">0</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">1</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.<span class="number">2</span>.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c4-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TxR.blf&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TM.blf&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TMContainer00000000000000000001.regtrans-ms&quot; &quot;&quot;</span><br><span class="line">movefile.exe &quot;C:\Windows\System32\config\TxR\&#123;<span class="number">711988</span>c5-afbd-<span class="number">11</span>e6-<span class="number">80</span>c9-<span class="number">782</span>bcb3928e1&#125;.TMContainer00000000000000000002.regtrans-ms&quot; &quot;&quot;</span><br></pre></td></tr></table></figure> <br> 下記と同様に表示されることをご確認後、システムの再起動を実施します。  <br> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Movefile v1.<span class="number">01</span> - copies over an <span class="keyword">in</span>-use file <span class="built_in">at</span> boot <span class="built_in">time</span> </span><br><span class="line"><span class="built_in">Move</span> successfully scheduled. </span><br></pre></td></tr></table></figure></li><li><p>改めて言語パックのインストールをご実施ください。 </p></li></ol><p>手順は以上となります。<br>上記情報が、少しでも皆様のご参考となれば幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;span style=&quot;color:red;&quot;&gt;

&lt;p&gt;&lt;strong&gt;Update: 2021/6/14&lt;/strong&gt; (Last: 5/10)&lt;br&gt;東西日本リージョンに Windows Server 2016 Datacenter の修正版イメージが展開され、修正後のイメージにて、通常通りの手順で言語パックのインストールが可能であることを確認いたしました。&lt;br&gt;その他リージョンにおいて、修正版イメージが展開されているかをご確認いただくには後述のコマンドをご実施ください。&lt;/p&gt;
&lt;/span&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Load Balancer Service にアクセス可能な IP アドレスを制限する</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-load-balancer-source-ranges/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-load-balancer-source-ranges/</id>
    <published>2021-06-10T04:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.376Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの桐井です。</p><p>AKS に作成した Service (type: LoadBalancer) に対して、アクセス可能な IP アドレス範囲を NSG で制限する方法をご紹介いたします。</p><span id="more"></span><h2 id="AKS-クラスターの-NSG"><a href="#AKS-クラスターの-NSG" class="headerlink" title="AKS クラスターの NSG"></a>AKS クラスターの NSG</h2><p>AKS クラスターを作成すると、クラスターを構成する Azure リソースの 1 つとしてネットワーク セキュリティ グループ (NSG) が作成されます。</p><p>AKS 上に Load Balancer タイプの Service をデプロイすると、Service の内容にもとづいて外部ロード バランサーが構成されます。あわせて、NSG に受信セキュリティ規則が作成され、インターネットから外部ロード バランサーに対するアクセスが許可されます。</p><p>以下のスクリーンショットは、80/TCP を公開する Service をデプロイしたあとの NSG の様子です。ソースが Internet、宛先が外部ロード バランサーの IP アドレスとなった受信セキュリティ規則が作成されています。</p><p><img src="/blog/containers/aks-load-balancer-source-ranges/aks-load-balancer-source-ranges01.png" alt="既定の NSG に Service 用の受信セキュリティ規則が作成された様子"></p><h2 id="Service-へのアクセスを特定の-IP-アドレス範囲のみ許可する"><a href="#Service-へのアクセスを特定の-IP-アドレス範囲のみ許可する" class="headerlink" title="Service へのアクセスを特定の IP アドレス範囲のみ許可する"></a>Service へのアクセスを特定の IP アドレス範囲のみ許可する</h2><p>Service の YAML に <code>spec.loadBalancerSourceRanges</code> フィールドを追加することで、NSG 受信セキュリティ規則のソース アドレスをカスタマイズすることが可能です。<br>これにより、Service へのアクセスを特定の IP アドレス範囲のみ許可することが実現できます。</p><blockquote><p>ご参考情報: Azure Kubernetes Service (AKS) でパブリック Standard Load Balancer を使用する<br>「受信トラフィックを特定の IP 範囲に制限する」が該当のドキュメント項目です。<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/load-balancer-standard#restrict-inbound-traffic-to-specific-ip-ranges">https://docs.microsoft.com/ja-jp/azure/aks/load-balancer-standard#restrict-inbound-traffic-to-specific-ip-ranges</a></p></blockquote><p>下記が YAML の記述例です。<code>spec.loadBalancerSourceRanges</code> 配下に、アクセスを許可したい IP アドレス範囲を CIDR 表記で記述します。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">azure-vote-front</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">azure-vote-front</span></span><br><span class="line">  <span class="attr">loadBalancerSourceRanges:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">192.0</span><span class="number">.2</span><span class="number">.10</span><span class="string">/32</span>    <span class="comment"># 単一のアドレスの許可</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">198.51</span><span class="number">.100</span><span class="number">.0</span><span class="string">/24</span>  <span class="comment"># アドレス範囲の許可</span></span><br></pre></td></tr></table></figure><p>上記 YAML を AKS クラスターにデプロイします。外部ロード バランサーに IP アドレス (EXTERNAL-IP) が割り当てられました。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> kubectl apply -f service.yaml</span></span><br><span class="line">service/azure-vote-front created</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">%</span><span class="bash"> kubectl get svc</span></span><br><span class="line">NAME              TYPE          CLUSTER-IP   EXTERNAL-IP   PORT(S)       AGE</span><br><span class="line">azure-vote-front  LoadBalancer  10.0.98.178  20.xxx.xxx.1  80:32730/TCP  83s</span><br><span class="line">kubernetes        ClusterIP     10.0.0.1     &lt;none&gt;        443/TCP       6m45s</span><br></pre></td></tr></table></figure><p>Azure ポータルでクラスター既定の NSG を確認します。受信セキュリティ規則が 2 つ作成され、それぞれソースが <code>loadBalancerSourceRanges</code> で指定したアドレス範囲になっていることが確認できます。</p><p><img src="/blog/containers/aks-load-balancer-source-ranges/aks-load-balancer-source-ranges02.png" alt="loadBalancerSourceRanges を記述した場合: 指定したアドレス範囲で受信セキュリティ規則が作成される"></p><div class="alert is-info"><p class="alert-title">Note</p><p><code>loadBalancerSourceRanges</code> は Azure 固有のフィールドではなく、Kubernetes API で用意されている共通のフィールドです。この設定値を読み取った Cloud Provider が、各クラウド サービスのネットワーク制限機能を操作するという仕組みで、Azure の場合では NSG ルールが構成されるという動作になっています。</p><p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#servicespec-v1-core">Kubernetes API Reference Docs - ServiceSpec v1 core</a></p></div><h3 id="内部ロード-バランサーでも利用できますか？"><a href="#内部ロード-バランサーでも利用できますか？" class="headerlink" title="内部ロード バランサーでも利用できますか？"></a>内部ロード バランサーでも利用できますか？</h3><p>NSG によるアクセス元アドレスの制限は、内部ロード バランサーを使用する Service においても利用可能です。</p><p>YAML では <code>metadata.annotations</code> に <code>azure-load-balancer-internal: true</code> のアノテーションを追加し、外部ロード バランサーの場合と同様に <code>spec.loadBalancerSourceRanges</code> フィールドを記述します。</p><p>内部ロード バランサーで Service を作成する方法は、下記ドキュメントをご参照ください。</p><blockquote><p>Azure Kubernetes Service (AKS) で内部ロード バランサーを使用する<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/internal-lb">https://docs.microsoft.com/ja-jp/azure/aks/internal-lb</a></p></blockquote><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、AKS に作成した Service (type: LoadBalancer) に対して、NSG でアクセス可能な IP アドレス範囲を制限する方法をご紹介いたしました。</p><p>Service へアクセス可能なネットワークを、オンプレミス環境や特定の VNet などに制限する場合にご活用いただけます。また、NSG ルールをアプリケーション用の YAML マニフェストとあわせて記述できるため、管理面でのメリットがございます。</p><p>AKS では Kubernetes を介して各種 Azure リソースが自動的に構成されます。クラスターが正常動作しなくなる恐れがございますので、ノード リソース グループ (MC_*) 内の自動作成された NSG や、その他 Azure リソースに対しては、手動で変更を加えないようにしましょう。</p><blockquote><p>Azure Kubernetes Service (AKS) についてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/faq#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group">ノード リソース グループ内の AKS リソースのタグや他のプロパティを変更できますか?</a></p></blockquote><div class="alert is-info"><p class="alert-title">Note</p><p>カスタム VNet の NSG 変更はサポートされています。</p><p>Azure Kubernetes Service のサポート ポリシー - <a href="https://docs.microsoft.com/ja-jp/azure/aks/support-policies#network-ports-access-and-nsgs">ネットワーク ポート、アクセス、NSG</a></p></div><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;AKS に作成した Service (type: LoadBalancer) に対して、アクセス可能な IP アドレス範囲を NSG で制限する方法をご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Windows VM で完全メモリ ダンプを採取する方法</title>
    <link href="https://jpaztech.github.io/blog/vm/how_to_get_a_complete_memory_dump/"/>
    <id>https://jpaztech.github.io/blog/vm/how_to_get_a_complete_memory_dump/</id>
    <published>2021-06-10T04:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.548Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの宇田です。<br>今回は、Azure Windows VM での完全メモリ ダンプの採取手順について、情報を更新した上で改めてご紹介いたします。</p><p>更新元の記事：<a href="https://docs.microsoft.com/en-us/archive/blogs/jpaztech/how_to_get_a_complete_memory_dump">Azure VM (Windows) で完全メモリ ダンプを採取する方法</a></p><span id="more"></span><hr><h2 id="ダンプ解析について"><a href="#ダンプ解析について" class="headerlink" title="ダンプ解析について"></a>ダンプ解析について</h2><p>Azure VM として稼働している Windows OS がハングした際など、完全メモリ ダンプを採取して解析を行うことが、有効な調査手段となる場合があります。</p><p>一方で、Azure に限ったお話しではありませんが、ダンプから原因調査を行うためには、”現象が発生している際に” ダンプを採取する必要があるほか、解析を行っても原因特定に至らない場合もあるため、必ずしもダンプの解析を行う事が最善の策とは限りません。こうした点については、以下の投稿でも詳しくご説明しておりますので、まずはご一読いただく事を推奨いたします。</p><blockquote><p>Azure 上で利用している Windows 仮想マシンがフリーズしたら (2018/8/28 更新)<br><a href="https://jpaztech1.z11.web.core.windows.net/Azure%E4%B8%8A%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8BWindows%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8C%E3%83%95%E3%83%AA%E3%83%BC%E3%82%BA%E3%81%97%E3%81%9F%E3%82%89(2018828%E6%9B%B4%E6%96%B0).html">https://jpaztech1.z11.web.core.windows.net/Azure上で利用しているWindows仮想マシンがフリーズしたら(2018828更新).html</a></p></blockquote><p>また、上記の投稿でもご案内しております通り、ご採取いただいたダンプの解析を Microsoft のサポート サービスで承る場合、原則としてプレミア サポート契約が必要となりますので、その点はご承知おきいただければと思います。IaaS として稼働する Azure VM 内の (Windows OS の) 設定や挙動に関してのお問い合わせは、Azure のサポート契約 (Developer / Standard / Professional Direct 等) では承ることが出来ず、Windows のサポート契約が必要となりますので、何卒ご了承ください。</p><blockquote><p>Azure IaaS における有償 Azure テクニカル サポートの対応範囲<br><a href="https://jpaztech.github.io/blog/other/azure_technical_support_explained/">https://jpaztech.github.io/blog/other/azure_technical_support_explained/</a></p></blockquote><hr><h2 id="完全メモリ-ダンプを採取するための-Windows-OS-の事前設定について"><a href="#完全メモリ-ダンプを採取するための-Windows-OS-の事前設定について" class="headerlink" title="完全メモリ ダンプを採取するための Windows OS の事前設定について"></a>完全メモリ ダンプを採取するための Windows OS の事前設定について</h2><p>物理メモリ上のデータを完全メモリ ダンプとして出力させるためには、事前に以下の設定が必要となります。こちらの設定を行っていない既定の状態でも、自動メモリ ダンプなどの採取はいただけますが、完全メモリ ダンプとして採取されたい場合には、明示的に設定をお願いいたします。</p><p>なお、物理メモリを多く搭載した VM をご利用の場合、完全メモリ ダンプの採取に長時間を要すほか、出力先のディスクにも大きな空き容量が必要となります。このため、ご利用の環境やお客様側で必要とされるダンプの種類に合わせて、適宜設定をいただければと思います。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>下記の手順には、レジストリの編集方法が記載されています。</p><p>レジストリを誤って変更すると、深刻な問題が発生することがあります。</p><p>レジストリを編集する際には充分に注意し、ユーザー自身の責任において行ってください。</p><p>万一に備えて、編集の前にレジストリをバックアップしておくと、問題が発生した場合にレジストリを復元することができます。</p><p>バックアップおよび復元方法の詳細は、サポート技術情報「<a href="https://support.microsoft.com/ja-jp/help/322756/">Windows でレジストリをバックアップおよび復元する方法</a>」をご確認ください。</p></div><h3 id="1-ページ-ファイルの大きさを-物理メモリ-400-MB-以上の大きさに設定する"><a href="#1-ページ-ファイルの大きさを-物理メモリ-400-MB-以上の大きさに設定する" class="headerlink" title="1. ページ ファイルの大きさを 物理メモリ + 400 MB 以上の大きさに設定する"></a>1. ページ ファイルの大きさを 物理メモリ + 400 MB 以上の大きさに設定する</h3><div class="alert is-info"><p class="alert-title">Note</p><p>大容量の物理メモリを搭載し、且つ、非常に多くのドライバーをインストールした環境に対しては、ダンプ ファイルの取得を目的としたページング ファイルの大きさにおいて、”物理メモリ + 400 MB” の値が必要となる場合ございます。</p><p>本手順では、上記環境においてもご対応いただけるよう、ページ ファイルの大きさを “物理メモリ + 400 MB” 以上の大きさとしてご案内しております。</p></div><h4 id="GUI-から設定する場合"><a href="#GUI-から設定する場合" class="headerlink" title="GUI から設定する場合"></a>GUI から設定する場合</h4><ol><li>[ファイル名を指定して実行] から “sysdm.cpl” を起動し、[システムのプロパティ] を起動します。</li><li>[詳細設定] タブに移動し、[パフォーマンス] の [設定] ボタンをクリックします。</li><li>[詳細設定] タブに移動し、[仮想メモリ] の [変更] ボタンをクリックします。</li><li>[すべてのドライブのページング ファイルのサイズを自動的に管理する] を無効にします。</li><li>任意のボリュームをクリックします。</li></ol><p>例: メモリ 8 GB の VM サイズの場合<br><img src="/blog/vm/how_to_get_a_complete_memory_dump/01.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>一時ディスク (Temporary Storage / 既定では D ドライブ) がある VM サイズをご利用の場合は、一時ディスクをご利用いただければと存じます。</p><p>一時ディスクがない VM サイズをご利用の場合は、任意のデータ ディスクをアタッチいただき、データ ディスク上のボリュームをご利用ください。</p></div><ol start="6"><li>[カスタム サイズ] を有効にし、[初期サイズ]、[最大サイズ] に物理メモリ + 400 MB 以上の数値を入力します。</li><li>[設定] ボタンをクリック後、[OK] をクリックします。</li></ol><h4 id="レジストリから設定する場合"><a href="#レジストリから設定する場合" class="headerlink" title="レジストリから設定する場合"></a>レジストリから設定する場合</h4><p>直接レジストリを編集することでも、ページング ファイルの設定が可能です。<br>対象のレジストリ キーと値は下記のとおりです。</p><blockquote><p>キー　 :  HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SessionManager\MemoryManagement<br>値　　 : PagingFiles<br>タイプ : REG_MULTI_SZ</p></blockquote><p>PagingFiles は下記の形式で記載します。<br>初期サイズと最大サイズは、物理メモリ + 400 MB 以上の数値を入力します。</p><blockquote><p>&lt;ページ ファイル保存先&gt; &lt;初期サイズ (MB)&gt; &lt;最大サイズ (MB)&gt;</p><p>例: メモリ 8 GB の VM サイズの場合<br>d:\pagefile.sys 8592 8592</p></blockquote><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/02.png"></p><h3 id="2-完全メモリ-ダンプ-Full-Dump-が生成される設定にする"><a href="#2-完全メモリ-ダンプ-Full-Dump-が生成される設定にする" class="headerlink" title="2. 完全メモリ ダンプ (Full Dump) が生成される設定にする"></a>2. 完全メモリ ダンプ (Full Dump) が生成される設定にする</h3><h4 id="GUI-から設定する場合-1"><a href="#GUI-から設定する場合-1" class="headerlink" title="GUI から設定する場合"></a>GUI から設定する場合</h4><ol><li>[ファイル名を指定して実行] から “sysdm.cpl” を起動し、[システムのプロパティ] を起動します。</li><li>[詳細設定] タブに移動し、[起動と回復] の [設定] ボタンをクリックします。</li><li>[システム エラー] 項目の [デバッグ情報の書き込み] で [完全メモリ ダンプ] を選択します。</li><li>また、メモリ ダンプ ファイルの保存先を変更する場合は [ダンプ ファイル] のパスを変更します。</li><li>完了しましたら [OK] ボタンをクリックします。</li></ol><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/13.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>メモリ ダンプ ファイルは、物理メモリ サイズと同等のサイズとなります。</p><p>既定では C:\Windows 配下に MEMORY.DMP という名前でファイルが作成されることとなりますが、もし、C ドライブの空き容量が足りない場合などは、設定したページング ファイルのサイズ以上の充分な空き容量があるボリュームを保存先にご設定ください。</p></div><h4 id="レジストリから設定する場合-1"><a href="#レジストリから設定する場合-1" class="headerlink" title="レジストリから設定する場合"></a>レジストリから設定する場合</h4><p>下記のレジストリの値を設定してください。対象のレジストリ キーと値は下記のとおりです。</p><blockquote><p>キー　 : HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\CrashControl<br>値　　 : CrashDumpEnabled<br>タイプ : REG_DWORD<br>設定値 : 1</p></blockquote><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/11.png"></p><p>また、メモリ ダンプの出力先は下記にて確認できます。</p><blockquote><p>キー　 : HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\CrashControl<br>値　　 : DumpFile<br>タイプ : REG_EXPAND_SZ<br>既定値 : %SystemRoot%\MEMORY.DMP</p></blockquote><h3 id="3-NMI-から-STOP-エラーを発生させるように設定する"><a href="#3-NMI-から-STOP-エラーを発生させるように設定する" class="headerlink" title="3. NMI から STOP エラーを発生させるように設定する"></a>3. NMI から STOP エラーを発生させるように設定する</h3><p>下記のレジストリの値を設定してください。NMICrashDump がない場合には、新規に作成してください。</p><blockquote><p>キー　 : HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CrashControl<br>値　　 : NMICrashDump<br>タイプ : REG_DWORD<br>設定値 : 1</p></blockquote><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/03.png"></p><h3 id="4-VM-を再起動する"><a href="#4-VM-を再起動する" class="headerlink" title="4. VM を再起動する"></a>4. VM を再起動する</h3><p>Azure Portal から VM を再起動させます。</p><hr><h2 id="ダンプの採取手順について"><a href="#ダンプの採取手順について" class="headerlink" title="ダンプの採取手順について"></a>ダンプの採取手順について</h2><p>上記の設定後、OS ハングなどの事象が再現したタイミングで、Azure Windows VM のシリアル コンソールから NMI を発行して、完全メモリ ダンプを採取します。</p><p>なお、NMI の発行に伴い対象の Azure Windows VM ではブルー スクリーンが発生し、OS が強制再起動されることになりますので、未保存のデータ (物理メモリ上からディスクへ書き戻されていないデータ) が消失する点にご留意ください。</p><h3 id="1-ブート診断を設定する"><a href="#1-ブート診断を設定する" class="headerlink" title="1. ブート診断を設定する"></a>1. ブート診断を設定する</h3><ol><li><p>対象の Azure VM のシリアル コンソールが利用できるかを確認し、利用できない場合には、ブート診断を [カスタム ストレージ アカウントで有効にする] 必要があります。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/04.png"></p></li><li><p>左メニュー ”サポート + トラブルシューティング” の [ブート診断] をクリックし、[設定] をクリックします。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/05.png"></p></li><li><p>[カスタム ストレージ アカウントで有効にする] を選択し、任意のストレージ アカウントを選択して、[保存] をクリックします。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/06.png"></p></li></ol><h3 id="2-シリアル-コンソールから-NMI-を発行します"><a href="#2-シリアル-コンソールから-NMI-を発行します" class="headerlink" title="2.シリアル コンソールから NMI を発行します"></a>2.シリアル コンソールから NMI を発行します</h3><ol><li><p>シリアル コンソールの画面を開き、SAC&gt; と表示されるまで待ってから、上部のボタンより [マスク不可能割込み (NMI) を送信する / Send Non-Maskable Interrupt (NMI)] をクリックします。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/07.png"></p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/08.png"></p></li><li><p>NMI が発行されると、以下のようなメッセージが表示され、物理メモリ上のデータがダンプ ファイルとして指定の場所 (既定: C:\Windows\MEMORY.DMP) に書き出されます。<br>末尾の表示が 100 % となった後、OS が再起動いたしますので、起動するまでしばらくお待ちください。<br>物理メモリの大きな VM をご利用の場合、ディスクへの書き出しにお時間を要す場合があります。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/09.png"></p><p>なお、対象の Azure VM に対して強制割り込み (NMI) が発行されると、Windows OS であれば、ブルースクリーンの状態となります。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/10.png"></p></li></ol><h3 id="3-ダンプ-ファイルを収集します"><a href="#3-ダンプ-ファイルを収集します" class="headerlink" title="3. ダンプ ファイルを収集します"></a>3. ダンプ ファイルを収集します</h3><ol><li><p>OS の起動後に RDP 接続を行うと、予期せぬ再起動が発生した事を示す画面が表示されます。</p></li><li><p>事前設定の手順 2. でレジストリに設定したフォルダ (既定: C:\Windows\MEMORY.DMP) に、ダンプ ファイルが出力されます。<br>こちらを適宜ダウンロードください。</p><p><img src="/blog/vm/how_to_get_a_complete_memory_dump/12.png"></p></li></ol><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>Windows OS にてブルー スクリーンが発生し、再起動時にダンプ ファイルが出力された際には、イベント ログにもその旨が記録されます。<br>ダンプ ファイルが出力されているのか、その出力先がどこなのか分からない場合には、イベント ログをご確認ください。</p><p>例:<br><img src="/blog/vm/how_to_get_a_complete_memory_dump/14.png"></p><p>以上となりますが、いかがでしたでしょうか。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの宇田です。&lt;br&gt;今回は、Azure Windows VM での完全メモリ ダンプの採取手順について、情報を更新した上で改めてご紹介いたします。&lt;/p&gt;
&lt;p&gt;更新元の記事：&lt;a href=&quot;https://docs.microsoft.com/en-us/archive/blogs/jpaztech/how_to_get_a_complete_memory_dump&quot;&gt;Azure VM (Windows) で完全メモリ ダンプを採取する方法&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Azure 仮想マシンにおける操作 (再起動、停止/起動、再デプロイ、再適用) について</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-operation/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-operation/</id>
    <published>2021-05-24T08:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.604Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの洪です。</p><p>Azure 仮想マシンで予期せぬ問題が発生した際に、切り分けとして再起動や再デプロイをご案内することがありますが、その際、お客様よりそれぞれの操作の違いや目的についてご質問いただくことがあります。</p><p>そこで本稿では、 Azure 仮想マシンに対して行う操作として、「再起動」、「停止 (割り当て解除) / 起動」、 「再デプロイ」、「再適用」の違いに関して説明します。</p><span id="more"></span><h2 id="■-各操作に関する概要"><a href="#■-各操作に関する概要" class="headerlink" title="■ 各操作に関する概要"></a>■ 各操作に関する概要</h2><p>各操作をご実施いただいた際に、「ゲスト OS の再起動」や「物理ホストの移動」が発生するか否かについて、下記の表の通りおまとめします。</p><table><thead><tr><th>操作</th><th>ゲスト OS の再起動</th><th>物理ホストの移動</th></tr></thead><tbody><tr><td>再起動</td><td>〇</td><td>×</td></tr><tr><td>停止 (割り当て解除) / 起動</td><td>〇</td><td>△ ※1</td></tr><tr><td>再デプロイ</td><td>〇</td><td>〇</td></tr><tr><td>再適用</td><td>△ ※2</td><td>×</td></tr></tbody></table><p>※1 明示的に物理ホスト サーバーの移動を行うわけではございません。可能性として、停止前と同一の物理ホスト サーバーで起動する場合もございます。<br>※2 仮想マシンの再起動が必須となる操作ではありませんが、目標となるあるべき状態 (Goal State) に実体が追いつこうとした動作の結果、再起動が発生する可能性があります。</p><hr><h2 id="■-仮想マシンの再起動"><a href="#■-仮想マシンの再起動" class="headerlink" title="■ 仮想マシンの再起動"></a>■ 仮想マシンの再起動</h2><p>再起動は、<strong>ゲスト OS の再起動</strong> を実施する操作です。ゲスト OS として Graceful Shutdown ※1 を実施し、その後起動します。<br>Graceful Shutdown とは、仮想マシンをシャットダウンする際にシステム内部で決められた手順に従い正常に仮想マシンを終了させることを意味します。<br>再起動による物理ホスト サーバーの移動は発生しません。<br>ゲスト OS 内のプロセスが正常な状態となっていない場合の切り分けとして、再起動の実行をご案内しています。</p><h3 id="Azure-Portal-での操作画面"><a href="#Azure-Portal-での操作画面" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-restart.png"></p><hr><h2 id="■-仮想マシンの停止-割り当て解除-起動"><a href="#■-仮想マシンの停止-割り当て解除-起動" class="headerlink" title="■ 仮想マシンの停止 (割り当て解除) / 起動"></a>■ 仮想マシンの停止 (割り当て解除) / 起動</h2><p>停止 (割り当て解除) は、仮想マシンが稼働する <strong>物理ホスト サーバーから割り当てられているリソースの割り当てを解除</strong> する操作であり、起動は <strong>物理ホスト サーバーからリソースを割り当てる</strong> 操作です。<br>再デプロイと異なり、明示的に別の物理ホスト サーバーでデプロイを行うための手段ではありませんが、起動によって仮想マシンがデプロイされる物理ホスト サーバーは前回と異なる場合がほとんどになります。</p><p>停止 (割り当て解除) では、仮想マシンとしての課金はかかりません。(※ ディスクの課金はかかります。)</p><blockquote><p>ご参考) 仮想マシンの課金の仕組み<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/dsazurejp/23">https://docs.microsoft.com/ja-jp/archive/blogs/dsazurejp/23</a></p></blockquote><h3 id="Azure-Portal-での操作画面-1"><a href="#Azure-Portal-での操作画面-1" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-stop.png"><br><img src="/blog/vm/vm-operation/vm-start.png"></p><p>ゲスト OS 上でのみシャットダウンを実行した場合には、ポータルの画面より仮想マシンの状態が <strong>停止済み (割り当て解除)</strong> ではなく、<strong>停止済み</strong> と表記されます。この場合はリソースがまだ割り当てられている状態との意味ですので課金が続けられます。</p><hr><h2 id="■-仮想マシンの再デプロイ"><a href="#■-仮想マシンの再デプロイ" class="headerlink" title="■ 仮想マシンの再デプロイ"></a>■ 仮想マシンの再デプロイ</h2><p>再デプロイとは、仮想マシンが稼働する <strong>物理ホスト サーバーを明示的に変更</strong> する操作です。<br>つまり、仮想マシンへのリソース割り当てを一度解除し、これまで稼働していた物理ホスト サーバーとは別の物理ホスト サーバーにて、仮想マシンに再度リソース割り当てを行います。<br>割り当ての対象となるリソースとは、vCPU コア、メモリ、NIC、一時ディスクなどの物理リソースです。</p><p>物理ホスト サーバー起因の問題が疑われている場合の切り分けとして、再デプロイの実行をご案内しています。</p><blockquote><p>ご参考) ホスト サーバーの障害<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/understand-vm-reboot#host-server-faults">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/understand-vm-reboot#host-server-faults</a></p></blockquote><h3 id="Azure-Portal-での操作画面-2"><a href="#Azure-Portal-での操作画面-2" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-redeploy.png"><br>なお、再デプロイに関しては、下記ブログ記事にて Azure PowerShell での操作方法などをご紹介しておりますので、ご参考としていただけますと幸いです。</p><blockquote><p>ご参考) Azure 仮想マシンの再デプロイ<br><a href="https://jpaztech.github.io/blog/vm/vm-redeploy/">https://jpaztech.github.io/blog/vm/vm-redeploy/</a></p></blockquote><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><p>再デプロイを行う際は、下記の 2 点を注意する必要があります。</p><ul><li>一時ディスクがある仮想マシン サイズをご利用の場合は、既存の一時ディスクは破棄され、新しくデプロイ先となった物理ホスト サーバーより再度割り当てられます。</li><li>仮想マシンに関連付けられた動的な IP アドレスは更新されます。</li></ul><hr><h2 id="■-仮想マシンの再適用"><a href="#■-仮想マシンの再適用" class="headerlink" title="■ 仮想マシンの再適用"></a>■ 仮想マシンの再適用</h2><p>Azure のリソースの変更処理にあたっては、内部的に 「あるべき状態 (Goal State)」 と「実体」 という概念があります。 リソースに何かしらの変更処理が発生する際、まず Goal State が更新され、その後リソースの「実体」が更新された Goal State の状態と合致するように、変更処理が実行されます。つまり、「実体」 が「Goal State」 を追いかける動作になります。</p><p>再適用とは、同一物理ホスト サーバー内で リソースの あるべき状態 (Goal State) の情報を、リソースの実体にもう一度適用させる操作です。 何らかの理由でリソースの実体が Goal State の状態に遷移ができずエラーになってしまった変更処理に対して、もう一度同じ Goal State の情報を流し込む (適用する) ことで、前回の変更処理をやり直すことにより、仮想マシンの実体の状態と Azure 基盤側で保持している Goal Stateとの状態が不一致となっている状況の修正が試みられます。</p><p>この時、物理ホスト サーバーの移動は発生するわけではなく、また、再適用処理自体が VM の再起動を引き起こすわけではありません。しかし、その時点での仮想マシンの実体の状態と Goal State の内容の差によっては、上述の動作の結果、稀ではありますが再起動が発生する可能性があります。そのため、再適用の実行に当たっては、仮想マシンの再起動が発生しても差し支えない時間帯での実行をお勧めいたします。</p><p>仮想マシン プロビジョニング起因の問題が疑われている場合の切り分けとして、再適用の実行をご案内しています。</p><p>なお、再適用に関しては、下記公開情報に記載がございますので、併せてご確認ください。</p><p>新しい GoalState を仮想マシンにトリガーする<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/troubleshoot#trigger-a-new-goalstate-to-the-vm">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/troubleshoot#trigger-a-new-goalstate-to-the-vm</a></p><h3 id="Azure-Portal-での操作画面-3"><a href="#Azure-Portal-での操作画面-3" class="headerlink" title="Azure Portal での操作画面"></a>Azure Portal での操作画面</h3><p><img src="/blog/vm/vm-operation/vm-reapply.png"></p><hr><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの洪です。&lt;/p&gt;
&lt;p&gt;Azure 仮想マシンで予期せぬ問題が発生した際に、切り分けとして再起動や再デプロイをご案内することがありますが、その際、お客様よりそれぞれの操作の違いや目的についてご質問いただくことがあります。&lt;/p&gt;
&lt;p&gt;そこで本稿では、 Azure 仮想マシンに対して行う操作として、「再起動」、「停止 (割り当て解除) / 起動」、 「再デプロイ」、「再適用」の違いに関して説明します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Oparation" scheme="https://jpaztech.github.io/blog/tags/Oparation/"/>
    
  </entry>
  
  <entry>
    <title>Azure 仮想マシンの再デプロイ</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-redeploy/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-redeploy/</id>
    <published>2021-05-24T08:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.608Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの洪です。</p><p>Azure 仮想マシンで接続不可などの問題が発生した際に、Azure 仮想マシンがデプロイされている物理ホスト サーバー起因の問題の切り分けとして再デプロイをご案内することがあります。</p><p>今回は、当サポート チームの旧ブログでご紹介しておりました再デプロイに関する情報を更新した上で、改めて Azure 仮想マシンの再デプロイの概要と、その実施方法（Azure ポータル、Azure Powershell）をご紹介いたします。</p><p>更新元の記事：<a href="https://jpaztech1.z11.web.core.windows.net/%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%96%B0%E3%81%97%E3%81%84%E3%83%8E%E3%83%BC%E3%83%89%E3%81%B8%E5%86%8D%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B.html">仮想マシンを新しいノードへ再デプロイする</a></p><span id="more"></span><hr><h2 id="■-再デプロイ"><a href="#■-再デプロイ" class="headerlink" title="■ 再デプロイ"></a>■ 再デプロイ</h2><p>再デプロイとは、仮想マシンが稼働する<strong>物理ホスト サーバーを明示的に移動させる (変更する)</strong> 操作です。<br>仮想マシンが稼働する物理ホスト サーバーからリソースの割り当てを解除し、同じ内容の仮想マシンを他の場所 (前回とは別の物理ホスト サーバー)で展開することを意味します。<br>割り当ての対象となるリソースとは、vCPU コア、メモリ、NIC、一時ディスクなどの物理リソースを示します。</p><p><img src="/blog/vm/vm-redeploy/Redeploy-Virtual-Machine-to-new-Azure-node.jpg"></p><p>仮想マシンへの接続ができない (RDP/SSH) 等の問題が発生した際に、Azure プラットフォームや Azure ネットワークの根底にある問題起因である場合、リソースの再割り当て（再デプロイ）を実行することで接続障害が解消されることがあります。</p><p>再デプロイを行う際は、下記の 2 点を注意する必要があります。</p><ul><li>一時的なディスクのデータが失われるということ</li><li>仮想マシンに関連付けられた動的な IP アドレスが更新されるということ</li></ul><hr><h2 id="■-仮想マシンを新しい物理ホスト-サーバーへ再デプロイする"><a href="#■-仮想マシンを新しい物理ホスト-サーバーへ再デプロイする" class="headerlink" title="■ 仮想マシンを新しい物理ホスト サーバーへ再デプロイする"></a>■ 仮想マシンを新しい物理ホスト サーバーへ再デプロイする</h2><h3 id="■-Azure-ポータルを使用する"><a href="#■-Azure-ポータルを使用する" class="headerlink" title="■ Azure ポータルを使用する"></a>■ Azure ポータルを使用する</h3><ol><li>再デプロイする仮想マシンを選択し、 [ サポート＋トラブルシューティング ] ブレードの [ 再展開と再適用 ] ボタンをクリックします。<br>なお、再デプロイは、リソースの再割り当てを実施する作業であるため、仮想マシンが割り当て解除済みの状態ですと実施することができません。<br>仮想マシンが実行中か、停止中 (ゲスト OS のシャットダウンのみ) であることを確認してご実施ください。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-1.png"></p><ol start="2"><li>[ 再デプロイ ] ボタンをクリックします。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-2.png"></p><ol start="3"><li>“仮想マシンが正常に再デプロイされました” との通知が表示されましたら再デプロイ完了となります。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-portal-3.png"></p><h3 id="■-Azure-PowerShell-を利用して再デプロイを実施する"><a href="#■-Azure-PowerShell-を利用して再デプロイを実施する" class="headerlink" title="■ Azure PowerShell を利用して再デプロイを実施する"></a>■ Azure PowerShell を利用して再デプロイを実施する</h3><p>こちらの手順では下記の PowerShell モジュールを使用しています。最新のモジュールについては各リンクをご確認ください。</p><blockquote><ul><li>PowerShell 7.1<br>(<a href="https://docs.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell">PowerShell をインストールする</a>)</li><li>AzPowerShell 5.9.0<br>(<a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps">Azure PowerShell をインストールする</a>)</li></ul></blockquote><ol><li>ポータル上で対象仮想マシンの状態が ‘実行中’ または ‘停止済み’ であることを確認します。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-1.png"></p><ol start="2"><li>PowerShell を開き、下記の Azure ログイン コマンド (<a href="https://docs.microsoft.com/en-us/powershell/module/az.accounts/Connect-AzAccount?view=azps-5.9.0">Connect-AzAccount</a>) を実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span></span><br></pre></td></tr></table></figure><p>表示例 :<br><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-2.png"></p><ol start="3"><li>ログインが成功したら、サブスクリプション情報が表示されます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-3.png"></p><ol start="4"><li>1 つのアカウントに複数のサブスクリプション情報が含まれる場合は、一番最初のサブスクリプションが選択されます。そのため、必要に応じて作業するサブスクリプションを指定 (<a href="https://docs.microsoft.com/en-us/powershell/module/az.accounts/Set-AzContext?view=azps-5.9.0">Set-AzContext</a>) します。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzContext</span> <span class="literal">-Subscription</span> &lt;サブスクリプションID&gt;</span><br></pre></td></tr></table></figure><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-4.png"></p><ol start="5"><li>下記コマンド (<a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/set-azvm?view=azps-5.9.0#:~:text=The%20Set-AzVM%20cmdlet%20marks%20a%20virtual%20machine%20as,and%20use%20Sysprep%20to%20prepare%20the%20hard%20disk.">Set-AzVM</a>) で仮想マシンを再デプロイします。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-AzVM</span> <span class="literal">-Redeploy</span> <span class="literal">-ResourceGroupName</span> &lt;リソースグループ名&gt; <span class="literal">-Name</span> &lt;仮想マシン名&gt;</span><br></pre></td></tr></table></figure><p>  <img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-5.png"></p><ol start="6"><li>ポータル上で仮想マシンの状態が <strong>‘更新中’</strong> となっていることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-6.png"></p><ol start="7"><li>しばらく時間がたつと、PowerShell コマンドが成功していることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-7.png"></p><ol start="8"><li>ポータル上でも対象仮想マシンの状態が <strong>‘実行中’</strong> に戻っていることが確認できます。</li></ol><p><img src="/blog/vm/vm-redeploy/vm-redeploy-powershell-8.png"></p><hr><p>また、本記事は下記の公式ドキュメントを参考しております。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/redeploy-to-new-node-windows">新しい Azure ノードへの Windows 仮想マシンの再デプロイ</a></li><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/redeploy-to-new-node-linux">新しい Azure ノードへの Linux 仮想マシンの再デプロイ</a></li></ul><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの洪です。&lt;/p&gt;
&lt;p&gt;Azure 仮想マシンで接続不可などの問題が発生した際に、Azure 仮想マシンがデプロイされている物理ホスト サーバー起因の問題の切り分けとして再デプロイをご案内することがあります。&lt;/p&gt;
&lt;p&gt;今回は、当サポート チームの旧ブログでご紹介しておりました再デプロイに関する情報を更新した上で、改めて Azure 仮想マシンの再デプロイの概要と、その実施方法（Azure ポータル、Azure Powershell）をご紹介いたします。&lt;/p&gt;
&lt;p&gt;更新元の記事：&lt;a href=&quot;https://jpaztech1.z11.web.core.windows.net/%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E6%96%B0%E3%81%97%E3%81%84%E3%83%8E%E3%83%BC%E3%83%89%E3%81%B8%E5%86%8D%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B.html&quot;&gt;仮想マシンを新しいノードへ再デプロイする&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>カスタム DNS サーバー よくあるお問い合わせ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/network/custom-dns-faq/"/>
    <id>https://jpaztech.github.io/blog/network/custom-dns-faq/</id>
    <published>2021-05-21T02:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.396Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>Azure では、仮想ネットワークや仮想マシンに関連付いているネットワーク インターフェイス毎に、名前解決時の接続先となる DNS サーバーを複数指定することができます。</p><p>仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの概要については、下記の弊社公開技術情報にも記載がございますので、ご参考になれば幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#specify-dns-servers">DNS サーバーの指定</a></li></ul><p>このブログでは、仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーに関して、度々お問合せ頂く内容をご紹介させて頂きます。</p><span id="more"></span><hr><h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h2><h4 id="Q-仮想マシンに関連付いているネットワーク-インターフェースに設定している-DNS-サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。"><a href="#Q-仮想マシンに関連付いているネットワーク-インターフェースに設定している-DNS-サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。" class="headerlink" title="Q. 仮想マシンに関連付いているネットワーク インターフェースに設定している DNS サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。"></a>Q. 仮想マシンに関連付いているネットワーク インターフェースに設定している DNS サーバーを変更したところ、接続している仮想マシンが自動で再起動する旨のメッセージが表示されましたが、数分待っても再起動されることはありませんでした。手動で再起動する必要があるのでしょうか。</h4><p>A. ネットワーク インターフェースの DNS サーバー設定を変更した後、仮想マシンの再起動を手動で実施いただくことで、お客様のタイミングで DNS サーバーの IP アドレスをご変更頂けます。</p><p>カスタム DNS サーバーの設定を変更すると、仮想マシンの OS に設定を反映させるために、Azure 基盤による任意のタイミングで仮想マシンを再起動することが想定されています。</p><p>但し、Azure 基盤による任意のタイミングで仮想マシンを再起動するため、直ぐに仮想マシンが再起動される可能性はゼロではございませんが、基本的には設定変更後暫く時間が経過してから仮想マシンが再起動されることになります。</p><p>そのため、意図しないタイミングで再起動が発生しないように、お客様のタイミングで Azure ポータルより手動で仮想マシンの再起動を実施頂くことをご検討いただければと存じます (OS の再起動では、カスタム DNS サーバーの設定は反映されません)。</p><p>なお、Azure 基盤側で再起動を実施するより前にお客様側で仮想マシンを再起動していただければ、Azure 基盤による仮想マシンの再起動は行われません。</p><h4 id="Q-仮想ネットワークの-DNS-サーバー設定を変更しましたが、仮想マシンは自動で再起動されるのでしょうか。"><a href="#Q-仮想ネットワークの-DNS-サーバー設定を変更しましたが、仮想マシンは自動で再起動されるのでしょうか。" class="headerlink" title="Q. 仮想ネットワークの DNS サーバー設定を変更しましたが、仮想マシンは自動で再起動されるのでしょうか。"></a>Q. 仮想ネットワークの DNS サーバー設定を変更しましたが、仮想マシンは自動で再起動されるのでしょうか。</h4><p>A. ネットワーク インターフェースとは異なり、Azure 基盤による任意のタイミングで仮想マシンが再起動されることはございません。</p><p>仮想マシンの OS 上において “ipconfig /renew” を実行して頂くことで、仮想マシンの再起動をせずに DNS サーバーの設定変更を反映させることが可能です。</p><h4 id="Q-可用性セット内の仮想マシンに関連付いているネットワーク-インターフェースのカスタム-DNS-サーバーを変更したいのですが、可用性セットの仮想マシンは-1-台ずつ自動で再起動されるのでしょうか。"><a href="#Q-可用性セット内の仮想マシンに関連付いているネットワーク-インターフェースのカスタム-DNS-サーバーを変更したいのですが、可用性セットの仮想マシンは-1-台ずつ自動で再起動されるのでしょうか。" class="headerlink" title="Q. 可用性セット内の仮想マシンに関連付いているネットワーク インターフェースのカスタム DNS サーバーを変更したいのですが、可用性セットの仮想マシンは 1 台ずつ自動で再起動されるのでしょうか。"></a>Q. 可用性セット内の仮想マシンに関連付いているネットワーク インターフェースのカスタム DNS サーバーを変更したいのですが、可用性セットの仮想マシンは 1 台ずつ自動で再起動されるのでしょうか。</h4><p>A. 仮想ネットワークもしくはネットワークインターフェイスの DNS サーバー設定を変更する場合、可用性セットであることを考慮して、可用性セットの仮想マシンを順番に再起動するとは限りません。</p><p>Azure 基盤による任意のタイミングで仮想マシンを再起動するため、直ぐに仮想マシンが再起動される可能性はゼロではございませんが、基本的には DNS サーバー設定変更後、暫く時間が経過してから仮想マシンが再起動されることになります。</p><p>そのため、可用性セットを構成されている仮想マシンであれば、DNS サーバー設定を変更した後、 Azure ポータルより手動で 1 台ずつ順番に再起動を実施いただくことで、お客様のタイミングで DNS サーバーの IP アドレスの変更が反映されますので、ご検討いただければと存じます。</p><p>なお、Azure 基盤側で再起動を実施するより前にお客様側で仮想マシンを再起動していただければ、Azure 基盤による仮想マシンの再起動は行われません。</p><h4 id="Q-仮想ネットワークやネットワーク-インターフェースにカスタム-DNS-サーバーとして複数の-IP-アドレスを登録しているのですが、名前解決時は各-DNS-サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。"><a href="#Q-仮想ネットワークやネットワーク-インターフェースにカスタム-DNS-サーバーとして複数の-IP-アドレスを登録しているのですが、名前解決時は各-DNS-サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。" class="headerlink" title="Q. 仮想ネットワークやネットワーク インターフェースにカスタム DNS サーバーとして複数の IP アドレスを登録しているのですが、名前解決時は各 DNS サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。"></a>Q. 仮想ネットワークやネットワーク インターフェースにカスタム DNS サーバーとして複数の IP アドレスを登録しているのですが、名前解決時は各 DNS サーバーへ順次接続するのか、それとも同時に接続するのでしょうか。</h4><p>A. 複数のカスタム DNS サーバーの IP アドレスを指定された場合、どの DNS サーバーを参照するかは、仮想マシン上に構成された OS の動作に依存致します。</p><p>Azure の仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの動作として、設定されたカスタム DNS サーバーの設定値を仮想マシンの OS に構成情報として展開致しますが、Azure の設定値としてカスタム DNS サーバーの優先度を設定する機能は持ち合わせておりません。</p><p>上記の動作より、カスタム DNS サーバーとして指定される DNS サーバーはいずれにおいても、Azure 上の仮想マシンが意図せず通信できない事象などを回避するために、パブリック インターネットに名前解決ができる構成としていただくことを推奨しております。</p><p>お客様の通信要件において、参照する DNS サーバーに優先度をつけて名前解決する場合は、Azure の機能では設定できないため、OS 上の設定において構成頂ければと存じます。</p><h4 id="Q-Azure-PowerShell-のコマンドを用いて、仮想マシン毎にカスタム-DNS-サーバーの-IP-アドレスの一覧を出力する方法はありますでしょうか。"><a href="#Q-Azure-PowerShell-のコマンドを用いて、仮想マシン毎にカスタム-DNS-サーバーの-IP-アドレスの一覧を出力する方法はありますでしょうか。" class="headerlink" title="Q. Azure PowerShell のコマンドを用いて、仮想マシン毎にカスタム DNS サーバーの IP アドレスの一覧を出力する方法はありますでしょうか。"></a>Q. Azure PowerShell のコマンドを用いて、仮想マシン毎にカスタム DNS サーバーの IP アドレスの一覧を出力する方法はありますでしょうか。</h4><p>A. 指定したリソース グループ内において、仮想マシンが関連付いている全てのネットワーク インターフェースの DNS 設定を出力するサンプル コマンドは下記のようになります。</p><p>■ サンプル コマンド</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Get-AzNetworkInterface -ResourceGroupName 【リソース グループ名】 | ForEach-Object &#123;</span><br><span class="line">    if ($_.VirtualMachine -ne $null) &#123;</span><br><span class="line">        $myObject = [PSCustomObject]@&#123;</span><br><span class="line">            NIC = &quot;NIC: &quot; + $_.Name</span><br><span class="line">            VM = &quot; VM: &quot; + $_.VirtualMachine.Id.Substring($_.VirtualMachine.Id.LastIndexOf(&quot;/&quot;) + 1)</span><br><span class="line">            DNS = &quot;DNS: &quot; + $_.DnsSettings.DnsServers</span><br><span class="line">        &#125;</span><br><span class="line">        $myObject.NIC</span><br><span class="line">        $myObject.VM</span><br><span class="line">        $myObject.DNS</span><br><span class="line">        echo &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>【リソース グループ名】は、検索対象のリソース グループの名称に置き換えて実行して下さい。</p><p>■ 例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Get-AzNetworkInterface -ResourceGroupName &quot;rg-myresources&quot; | ForEach-Object &#123;</span><br><span class="line">    if ($_.VirtualMachine -ne $null) &#123;</span><br><span class="line">        $myObject = [PSCustomObject]@&#123;</span><br><span class="line">            NIC = &quot;NIC: &quot; + $_.Name</span><br><span class="line">            VM = &quot; VM: &quot; + $_.VirtualMachine.Id.Substring($_.VirtualMachine.Id.LastIndexOf(&quot;/&quot;) + 1)</span><br><span class="line">            DNS = &quot;DNS: &quot; + $_.DnsSettings.DnsServers</span><br><span class="line">        &#125;</span><br><span class="line">        $myObject.NIC</span><br><span class="line">        $myObject.VM</span><br><span class="line">        $myObject.DNS</span><br><span class="line">        echo &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>■　結果出力例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NIC: kaishiha930</span><br><span class="line"> VM: kaishiha</span><br><span class="line">DNS: 8.8.8.8 1.1.1.1 2.2.2.2 3.3.3.3 4.4.4.4 5.5.5.5</span><br><span class="line"></span><br><span class="line">NIC: server0774</span><br><span class="line"> VM: Server0</span><br><span class="line">DNS: 168.63.129.16</span><br></pre></td></tr></table></figure><p>上から順番に、ネットワーク インターフェースの名称、そのネットワーク インターフェースに関連付いている Azure VM の名称、そのネットワーク インターフェースの DNS 設定の結果になります。</p><p>なお、Get-AzNetworkInterface コマンドの詳細情報に関しては、下記の弊社公開技術情報のドキュメントにございます。ご参考になれば幸いです。</p><ul><li><a href="https://docs.microsoft.com/en-us/powershell/module/az.network/get-aznetworkinterface?view=azps-4.3.0">Get-AzNetworkInterface</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;Azure では、仮想ネットワークや仮想マシンに関連付いているネットワーク インターフェイス毎に、名前解決時の接続先となる DNS サーバーを複数指定することができます。&lt;/p&gt;
&lt;p&gt;仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーの概要については、下記の弊社公開技術情報にも記載がございますので、ご参考になれば幸いです。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#specify-dns-servers&quot;&gt;DNS サーバーの指定&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;このブログでは、仮想ネットワークやネットワーク インターフェースで設定可能なカスタム DNS サーバーに関して、度々お問合せ頂く内容をご紹介させて頂きます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure 上の Windows OS が起動しない場合の情報まとめ (2021 年 5 月 14 日更新版)</title>
    <link href="https://jpaztech.github.io/blog/vm/windows-noboot-summary/"/>
    <id>https://jpaztech.github.io/blog/vm/windows-noboot-summary/</id>
    <published>2021-05-14T09:00:00.000Z</published>
    <updated>2021-12-07T12:35:26.628Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>今回は、当サポートチームの旧ブログでご紹介しておりました Windows OS が起動しない (noboot) 場合の情報について、情報を更新した上で改めてご紹介いたします。</p><p>更新元の記事：<a href="https://jpaztech1.z11.web.core.windows.net/Azure%E4%B8%8A%E3%81%AEWindowsOS%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E6%83%85%E5%A0%B1%E3%81%BE%E3%81%A8%E3%82%81(2018%E5%B9%B48%E6%9C%8827%E6%97%A5%E7%89%88).html">Azure 上の Windows OS が起動しない場合の情報まとめ (2018 年 8 月 27 日版)</a></p><span id="more"></span><p>この Windows OS が起動しなくなる事象については、状況把握や復旧手段に関してご支援させていただいている際のポイントを、弊社 Windows サポートチームのブログからご紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>なお、上記 Windows OS 観点のブログに記載されている [3] - [6] を Azure 環境上でお試しいただく方法については、下記の別記事で紹介しています。</p><blockquote><p><strong>管理ディスクの場合：</strong><br>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</a></p></blockquote><blockquote><p><strong>非管理ディスクの場合：</strong><br>【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</a></p></blockquote><p>本記事では、Windows OS が起動しなくなる事象に関する Azure 観点での状況把握や復旧方法に関する Tips のまとめをご紹介します。</p><hr><h2 id="TIPS-1-ブート診断による画面確認"><a href="#TIPS-1-ブート診断による画面確認" class="headerlink" title="TIPS #1 ブート診断による画面確認"></a>TIPS #1 ブート診断による画面確認</h2><p>Windows VM ではブート診断を有効化していただくことで、Azure ポータル上から OS の画面ショットを見ることができます。<br>RDP 接続が出来ない場合には、ブート診断を使ってどのような画面になっているか確認をしましょう。<br>具体的な手順については、下記公開情報をご確認ください。</p><blockquote><p>ブート診断を使用して Azure の仮想マシンのトラブルシューティングを行う方法<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-diagnostics">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-diagnostics</a></p></blockquote><hr><h2 id="TIPS-2-Azure-における復旧方法"><a href="#TIPS-2-Azure-における復旧方法" class="headerlink" title="TIPS #2 Azure における復旧方法"></a>TIPS #2 Azure における復旧方法</h2><p>Windows OS が起動しなくなる事象は原因追及が困難な場合が多く、対処方法を実施しても必ず Windows OS が起動できるようになる保証はないことをご注意下さい。<br>最も確実な方法は <strong>バックアップから復旧させる方法</strong> になりますので、<strong>定期的なバックアップのご取得</strong> をご実施くださいますようお願いいたします。</p><p>もし、バックアップが存在しない場合には、上述の “<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ にて記載されているような対処をお試しいただきます。</p><h3 id="■-バックアップからリストアする"><a href="#■-バックアップからリストアする" class="headerlink" title="■ バックアップからリストアする"></a>■ バックアップからリストアする</h3><h4 id="Azure-Backup"><a href="#Azure-Backup" class="headerlink" title="Azure Backup"></a>Azure Backup</h4><p>Azure Backup にて、VM のバックアップを取得しておけば、何かあった場合に正常時の状態からの復元が行える可能性が高いです。<br>Azure Backup に関する公開情報をいくつかご紹介いたしますので、ご参考情報としてご確認いただけますと幸いです。</p><blockquote><p>Azure で仮想マシンをバックアップする<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-portal">https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-portal</a></p></blockquote><blockquote><p>Azure portal で Azure VM データを復元する方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></p></blockquote><blockquote><p>Azure VM バックアップのサポート マトリックス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas</a></p></blockquote><h4 id="スナップショット"><a href="#スナップショット" class="headerlink" title="スナップショット"></a>スナップショット</h4><p>Azure Backup を使用できない場合は、ディスク リソースのスナップショットを取得し、有事の際にはそのスナップショットからディスクを復元する方法もあります。<br>スナップショットの取得に関する詳細な手順に関しましては、下記の公開情報をご確認ください。<br>なお、ディスクのスナップショットは、Azure Backup と異なり VM の稼働状態で取るとデータに不整合が発生する場合があります。<br>スナップショットを作成する前に VM を停止することをお勧めします。</p><blockquote><p>ポータルまたは PowerShell を使用してスナップショットを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk</a><br>※ 管理ディスク用の手順になります。</p></blockquote><h4 id="OS-ディスクのスワップ"><a href="#OS-ディスクのスワップ" class="headerlink" title="OS ディスクのスワップ"></a>OS ディスクのスワップ</h4><p>ディスクを復元した際には、事象が発生した VM の OS ディスクと入れ替えることが可能です。<br>詳細な手順は下記をご確認ください。</p><blockquote><p>VM の OS ディスクをスワップする<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm</a><br>※ 管理ディスク用の手順になります。</p></blockquote><h3 id="■-復旧用の-VM-を使って対応する"><a href="#■-復旧用の-VM-を使って対応する" class="headerlink" title="■ 復旧用の VM を使って対応する"></a>■ 復旧用の VM を使って対応する</h3><p>起動ができない VM の OS ディスクを、他の正常な VM にデータ ディスクとして接続することで、当該 OS ディスクに対する操作が可能となります。</p><p>順序が前後しますが、”<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ 内で紹介している “[3] SFC (System File Checker)、[4] regback を用いたレジストリ復旧、[5] 更新プログラムのアンインストール、[6] ファイルシステムの破損チェック” は、この方法で実施することができます。</p><p>Azure 側の具体的な手順に関しては、再掲となりますが、下記の別記事でご紹介していますので、ご利用環境に合わせてご確認ください。</p><blockquote><p>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</a></p></blockquote><blockquote><p>【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順<br><a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</a></p></blockquote><p>なお、公開情報としては下記がございますのでご確認ください。</p><blockquote><p>Azure Portal から OS ディスクを復旧 VM にアタッチして Windows VM のトラブルシューティングを行う<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows</a></p></blockquote><h3 id="■-Windows-の回復コンソールを使用する"><a href="#■-Windows-の回復コンソールを使用する" class="headerlink" title="■ Windows の回復コンソールを使用する"></a>■ Windows の回復コンソールを使用する</h3><p>“<a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</a>“ 内で紹介している、”[1] スタートアップ修復、[2] Boot 構成情報の修正” を実施する場合、Windows の回復コンソールの立ち上げが必要となります。<br>回復コンソールは、Azure 上からは直接操作ができませんので、Nested Hyper-V をご利用いただくか、VHD ファイルをオンプレミス環境にダウンロードし Hyper-V 環境を構築することで行います。</p><p>オンプレミス環境に Hyper-V 環境が無い場合、Azure での Nested Hyper-V 用 VM を一時的に作成するということが便利です。<br>具体的な手順に関しては、下記ブログをご確認ください。</p><blockquote><p>Nested Hyper-V を使った VM の復旧<br><a href="https://docs.microsoft.com/en-us/archive/blogs/jpaztech/recover_vm_using_nested_hyperv">https://docs.microsoft.com/en-us/archive/blogs/jpaztech/recover_vm_using_nested_hyperv</a></p></blockquote><!-- 後で更新する --><p>なお、オンプレミス環境で回復コンソールの立ち上げを実施する場合に関しても、オンプレミス環境で行う “Hyper-V 構築 → VHD のダウンロード → VM の起動” といった手順は、Nested Hyper-V を使った手順とほぼ同様となりますので、ご参考となれば幸いです。</p><hr><h2 id="TIPS-3-バックアップ取得に関する-Tips"><a href="#TIPS-3-バックアップ取得に関する-Tips" class="headerlink" title="TIPS #3 バックアップ取得に関する Tips"></a>TIPS #3 バックアップ取得に関する Tips</h2><p>上述の通り、Windows OS としての対処をご実施いただいても、事象が 100％ 復旧するという保証はなく、最も確実な復旧方法はバックアップから復旧させる方法になります。<br>バックアップからのリストアであれば、復旧までの時間がある程度予測できることも利点と言えます。<br>復旧をより確実なものとするために、以下のような点についても心がけてください。</p><h3 id="■-バックアップの基本-Azure-Backup-で複数世代のバックアップを保持する"><a href="#■-バックアップの基本-Azure-Backup-で複数世代のバックアップを保持する" class="headerlink" title="■ バックアップの基本: Azure Backup で複数世代のバックアップを保持する"></a>■ バックアップの基本: Azure Backup で複数世代のバックアップを保持する</h3><p>Windows OS が起動できないという状態に陥った場合、何らかの形で Windows OS のデータ (レジストリやファイル システム、ファイル システムのメタデータ) が破損してしまっている場合があります。<br>このような場合において事例上少なくないのは、「バックアップを取得したその時点で、すでに何らかのデータが壊れてしまっていた」という状況です。</p><p>Azure Backup は、VM を止めずにバックアップを取得するができます。<br>ただし、稼働中の OS は、起動時に必要なファイルの一部が破損しても、次の再起動までは走り続けることができるという場合があります。</p><h4 id="Windows-イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか"><a href="#Windows-イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか" class="headerlink" title="Windows イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか"></a>Windows イメージに何らかの支障が発生した状態で稼働が続いているとどのようになるか</h4><p>「Windows VM を再起動したら、OS が正しく起動されなかった。OS の問題が起きているようなので、バックアップからリストアを行った。状況が改善しないため、何世代か前のバックアップを用いてリストアを複数試してみたが、どれをリストアしても同様に OS が正しく起動されない状態になってしまった。」といったシナリオになります。</p><p>もともと Windows OS 内のレジストリやファイル システムが破損していたがそのまま稼働していた場合、再起動時に問題が顕在化し、OS が正しく起動できない事象が発生します。</p><p>Azure Backup は「1 日ごとに 7 世代」といったポリシー設定に基づいて世代管理します。<br>その枠内で無事復旧できるイメージがあればいいですが、そうではない場合、Azure Backup でも復旧できないシナリオもある、ということをご紹介します。<br>稀で不運な事例ではありますが、リスクとしてご認識くださいますようお願いいたします。</p><h3 id="■-ディスクのスナップショットを活用しよう"><a href="#■-ディスクのスナップショットを活用しよう" class="headerlink" title="■ ディスクのスナップショットを活用しよう"></a>■ ディスクのスナップショットを活用しよう</h3><p>VM を再起動して無事に Windows OS が起動できたことが保証できるタイミングまでを含めて確認いただくことが一番安全ではありますが、再起動なんて月に 1 度か、それ以下しかしない、という場合も勿論あります。</p><p>その場合には、「正常な状態の VM を停止し、OS ディスクのスナップショットを作成しておく」ことをお勧めします。</p><p>上述の通り、データに不整合がある状態になることを防ぐため、スナップショットを作成する前に VM を停止することをお勧めします。<br>スナップショット作成のために、VM を停止 / 開始させることで、開始後に OS が正しく起動することを確かめることもできます。<br>(ゲスト OS のシャットダウンを実施してから VM の停止をご実施いただくとより安全です。)<br>(OS 起動が確約されるのであれば、前のバージョンのスナップショットは削除しても問題ないので、1 世代分のスナップショットを保持すればよいということになります。)</p><p>Windows OS にアプリケーションを追加したり、Windows Update を適用する、といったシステム変更に際してディスクのスナップショットを作成しておくと安心です。</p><h4 id="追加コストの話"><a href="#追加コストの話" class="headerlink" title="追加コストの話"></a>追加コストの話</h4><p>スナップショットの課金形態や考え方は、非管理ディスクと管理ディスクで若干異なります。<br>追加でコストが発生する部分となりますので、適切に理解をするため下記の通りご紹介します。</p><h4 id="非管理ディスクのスナップショット"><a href="#非管理ディスクのスナップショット" class="headerlink" title="非管理ディスクのスナップショット"></a>非管理ディスクのスナップショット</h4><p>非管理ディスクのスナップショットは、もとのディスク (VHD ファイル) のコピーではなく、その時点の差分データです。<br>そのため、VHD ファイルを誤って削除してしまうと、スナップショットも削除されてしまうのでご注意ください。<br>ただし課金の面では、差分の容量分のみが課金されます。</p><p>例:</p><ol><li>元々の使用量が 30 GB のVHDでスナップショットを作成する。<br>この時点ではスナップショットぶんの課金ゼロであり、30 GB の VHD の容量分のみの課金となる。</li><li>VHD ファイル上に 1 GB の変更が加わる。<br>この時点で以前のスナップショットとの差分で生じた 1 GB が加算された 31 GB ぶんの課金が発生する。</li></ol><p>上記の詳細については、下記公開情報をご確認ください。</p><blockquote><p>Blob スナップショットの課金方法について<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-how-snapshots-accrue-charges">https://docs.microsoft.com/ja-jp/rest/api/storageservices/understanding-how-snapshots-accrue-charges</a></p></blockquote><blockquote><p>Managed Disks の価格<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><blockquote><p>&lt;抜粋 (2021/5/14) &gt;<br>Premium SSD Managed Disks の完全なスナップショットとイメージを Standard ストレージに格納できます。<br>ローカル冗長 (LRS) とゾーン冗長 (ZRS) スナップショットのいずれかのオプションをお選びいただけます。<br>Standard LRS と Standard ZRS どちらのオプションでも、これらのスナップショットとイメージはディスクの使用量に応じて月々 ¥5.600/GB で課金されます。<br>たとえば、プロビジョニングされた容量が 64 GB のマネージド ディスクのスナップショットを作成し、実際に使用したデータ サイズが 10 GB だった場合、スナップショットは、使用したデータ サイズである 10 GB に対してのみ課金されます。<br>Premium SSD マネージド ディスク ストレージに保存することを選択した場合、1 か月あたり ¥17.024/GB で課金されます。</p></blockquote></blockquote><h4 id="管理ディスクのスナップショット"><a href="#管理ディスクのスナップショット" class="headerlink" title="管理ディスクのスナップショット"></a>管理ディスクのスナップショット</h4><p>管理ディスクのスナップショットは、もとのディスク (VHD ファイル) の完全な複製です。<br>そのため、スナップショットを作成した元のディスクを削除してもスナップショットは削除されず、スナップショットからディスクの作成 (復元) を実施することが可能です。<br>課金の面では、スナップショット元のデータのコピーのため、実使用量分のデータが課金対象になります。</p><p>管理ディスクは、P10 (Premium, 128GiB) や S10 (Standard, 128GiB) といった決まったサイズごとに課金枠が決まっていますが、スナップショットはその中の実容量をベースに課金されます。<br>つまり、128 GiB の VHD 中、10 GiB しか使われていなかったら、10 GiB 分のみがスナップショットの課金額となります。</p><p>なお、Premium ストレージのスナップショットを Standard ストレージに取る、ということも可能です。<br>例えば、P10 の管理ディスクとそのスナップショット (Standard ストレージ) に取得する場合、[もとのディスクの料金 (P10)] と、[Standard スナップショットの容量別課金 × 使用している実容量 GiB] の課金が発生することとなります。</p><h3 id="■-参考資料"><a href="#■-参考資料" class="headerlink" title="■ 参考資料"></a>■ 参考資料</h3><p>バックアップと高可用性、DR との違い、といった点も理解しておくことが重要です。<br>高可用性環境なら、VM 1 台の OS が起動しなかった場合にも復旧のための時間的猶予が生まれます。</p><p>下記ブログのアーカイブにて、Azure において様々に存在するダウンタイムを避けるサービスについて紹介しておりますので、ご参考情報としてご参照下さい。</p><blockquote><p>Azure エンジニアが解説する落ちないサービス入門<br><a href="https://blogs.technet.microsoft.com/jpaztech/2018/05/29/aiming_no_downtime/">https://blogs.technet.microsoft.com/jpaztech/2018/05/29/aiming_no_downtime/</a></p></blockquote><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;今回は、当サポートチームの旧ブログでご紹介しておりました Windows OS が起動しない (noboot) 場合の情報について、情報を更新した上で改めてご紹介いたします。&lt;/p&gt;
&lt;p&gt;更新元の記事：&lt;a href=&quot;https://jpaztech1.z11.web.core.windows.net/Azure%E4%B8%8A%E3%81%AEWindowsOS%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E6%83%85%E5%A0%B1%E3%81%BE%E3%81%A8%E3%82%81(2018%E5%B9%B48%E6%9C%8827%E6%97%A5%E7%89%88).html&quot;&gt;Azure 上の Windows OS が起動しない場合の情報まとめ (2018 年 8 月 27 日版)&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/</id>
    <published>2021-05-14T08:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.564Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。</p><span id="more"></span><p>Windows OS の復旧手順に関しては、Windows サポートチームのブログからご紹介しています。<br>本記事では、[対処方法] 編に記載されている切り分け [3] - [6] を Azure 環境上でお試しいただく方法について紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>本記事では、<span style="color:red;"><strong>管理ディスク</strong></span>をご利用の環境用の手順を紹介します。非管理ディスクをご利用の場合は、「<a href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/">【非管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</a>」をご確認ください。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol><li>当該仮想マシンの OS ディスクのスナップショットを取得します</li><li>スナップショットから、修復用 OS ディスクを作成します</li><li>復旧作業用仮想マシンに、修復用 OS ディスクを接続します</li><li>復旧作業用仮想マシンにて、切り分けを実施します</li><li>修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます</li></ol><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-当該仮想マシンの-OS-ディスクのスナップショットを取得します"><a href="#1-当該仮想マシンの-OS-ディスクのスナップショットを取得します" class="headerlink" title="1. 当該仮想マシンの OS ディスクのスナップショットを取得します"></a>1. 当該仮想マシンの OS ディスクのスナップショットを取得します</h3><p>Azure Portal より 仮想マシンを停止できるようであれば、停止してからご実施ください。</p><ol><li>Azure Portal より [Virtual Machine] - [&lt;当該仮想マシン&gt;] を開き、左メニュー “設定” から [ディスク] をクリックします。</li><li>[&lt;当該 OS ディスク&gt;] をクリックし、[スナップショットの作成] をクリックします。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/1.png"></p><ol start="3"><li>適宜、値を設定し、[確認および作成] - [作成] をクリックします。</li></ol><blockquote><p>スナップショットの作成<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk#use-the-azure-portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk#use-the-azure-portal</a></p></blockquote><h3 id="2-スナップショットから、修復用-OS-ディスクを作成します"><a href="#2-スナップショットから、修復用-OS-ディスクを作成します" class="headerlink" title="2. スナップショットから、修復用 OS ディスクを作成します"></a>2. スナップショットから、修復用 OS ディスクを作成します</h3><ol><li>Azure Portal にて [リソースの作成] をクリックし、検索窓に “Managed Disks” と入力します。</li><li>[作成] をクリックし、適宜値を設定します。<br>“ソースの種類” を [スナップショット] に指定し、1 にて作成したスナップショットを指定します。</li><li>[確認および作成] - [作成] をクリックします。</li></ol><blockquote><p>管理ディスク (Managed Disks) スナップショットより VM をデプロイする<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/deployvmfromsnapshot">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/deployvmfromsnapshot</a><br>「2. スナップショットより “ディスク” リソースを作成する」をご確認ください。</p></blockquote><h3 id="3-復旧作業用仮想マシンに、修復用-OS-ディスクを接続します"><a href="#3-復旧作業用仮想マシンに、修復用-OS-ディスクを接続します" class="headerlink" title="3. 復旧作業用仮想マシンに、修復用 OS ディスクを接続します"></a>3. 復旧作業用仮想マシンに、修復用 OS ディスクを接続します</h3><ol><li>本事象のトラブルシューティングを行う復旧作業用仮想マシンを別途ご準備いただき、作成した OS ディスクをデータ ディスクとして接続します。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/3.png"></p><ol start="2"><li>復旧作業用仮想マシンに RDP 接続します。</li></ol><h3 id="4-復旧作業用仮想マシンにて、切り分けを実施します"><a href="#4-復旧作業用仮想マシンにて、切り分けを実施します" class="headerlink" title="4.復旧作業用仮想マシンにて、切り分けを実施します"></a>4.復旧作業用仮想マシンにて、切り分けを実施します</h3><p>下記 Windows OS 観点のブログに記載されている [3] - [6] をお試し下さい。</p><blockquote><p>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法<br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>また、事象別のトラブルシューティングについては、下記公開情報に詳細が記載されています。併せてご確認ください。</p><blockquote><p>Azure 仮想マシンのブート エラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot</a></p></blockquote><h3 id="5-修復用-OS-ディスクを、対象仮想マシンの-OS-ディスクとスワップさせます"><a href="#5-修復用-OS-ディスクを、対象仮想マシンの-OS-ディスクとスワップさせます" class="headerlink" title="5. 修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます"></a>5. 修復用 OS ディスクを、対象仮想マシンの OS ディスクとスワップさせます</h3><ol><li>復旧作業用仮想マシンを停止し、データ ディスクとして接続されている修復した OS ディスクをデタッチします。</li><li>対象仮想マシンの OS ディスクを、修復した OS ディスクとスワップします。</li></ol><p><img src="/blog/vm/noboot-recovery-managed-disk/4.png"></p><p><img src="/blog/vm/noboot-recovery-managed-disk/5.png"></p><blockquote><p>VM の OS ディスクをスワップする<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows#swap-the-os-disk-for-the-vm</a></p></blockquote><ol start="3"><li>復旧対象仮想マシンを起動し、事象が解消されたかをご確認ください。</li></ol><p>手順は以上となります。</p><hr><h2 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h2><blockquote><p>Azure Portal から OS ディスクを復旧 VM にアタッチして Windows VM のトラブルシューティングを行う<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-recovery-disks-portal-windows</a></p></blockquote><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>【非管理ディスク編】 復旧 VM を使った Windows VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/noboot-recovery-unmanaged-disk/</id>
    <published>2021-05-14T08:30:00.000Z</published>
    <updated>2021-12-07T12:35:26.568Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。<br>本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。</p><span id="more"></span><p>Windows OS の復旧手順に関しては、Windows サポートチームのブログからご紹介しています。<br>本記事では、[対処方法] 編に記載されている切り分け [3] - [6] を Azure 環境上でお試しいただく方法について紹介しています。</p><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 概要</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-OutLine/</a></p></blockquote><blockquote><p><strong>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法</strong><br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>本記事では、<span style="color:red;"><strong>非管理ディスク</strong></span>をご利用の環境用の手順を紹介します。管理ディスクをご利用の場合は、「<a href="https://jpaztech.github.io/blog/vm/noboot-recovery-managed-disk/">【管理ディスク編】復旧 VM を使った Windows VM の Noboot 復旧手順</a>」をご確認ください。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol><li>復旧対象仮想マシンの OS ディスク VHD ファイルを複製します</li><li>復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします</li><li>復旧作業用仮想マシンにて、切り分けを実施します。</li><li>修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます。</li></ol><hr><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-復旧対象仮想マシンの-OS-ディスク-VHD-ファイルを複製します"><a href="#1-復旧対象仮想マシンの-OS-ディスク-VHD-ファイルを複製します" class="headerlink" title="1. 復旧対象仮想マシンの OS ディスク VHD ファイルを複製します"></a>1. 復旧対象仮想マシンの OS ディスク VHD ファイルを複製します</h3><p>Azure Storage Explorer または AzCopy をご利用いただく方法にて、復旧対象仮想マシンの OS ディスク VHD ファイルを複製します。　</p><h4 id="Azure-Storage-Explorer-をご利用いただく場合"><a href="#Azure-Storage-Explorer-をご利用いただく場合" class="headerlink" title="Azure Storage Explorer をご利用いただく場合"></a>Azure Storage Explorer をご利用いただく場合</h4><p>Azure Storage Explorer については、下記公開情報をご確認ください。</p><blockquote><p>Azure Storage Explorer<br><a href="https://azure.microsoft.com/ja-jp/features/storage-explorer/">https://azure.microsoft.com/ja-jp/features/storage-explorer/</a></p></blockquote><ol><li><p>復旧対象仮想マシンを停止 (割り当て解除) します。</p></li><li><p>Azure Storage Explorer にて [ストレージ アカウント] - [&lt;ストレージ アカウント名&gt;] - [Blob Containers] - [vhds (コンテナ―名)] を開き、復旧対象仮想マシンの OS ディスクの VHD を選択した状態で、[クローン] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/1.png"></p></li><li><p>“BLOB を新しい名前で複製” 画面にて [&lt;複製後の VHD 名&gt;] を入力し、[複製] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/2.png"></p></li><li><p>複製が完了した際には Azure Storage Explorer の “アクティビティ” に “転送完了” のメッセージが表示されます。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/3.png"></p></li></ol><h4 id="AzCopy-をご利用いただく場合"><a href="#AzCopy-をご利用いただく場合" class="headerlink" title="AzCopy をご利用いただく場合"></a>AzCopy をご利用いただく場合</h4><p>AzCopy については、下記公開情報をご確認ください。</p><blockquote><p>AzCopy を使ってみる<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10</a></p></blockquote><ol><li>復旧対象仮想マシンを停止 (割り当て解除) します。</li><li>AzCopy コマンドを下記の通り実行します。<br>構文：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./azcopy.exe <span class="built_in">copy</span> <span class="string">&quot;https://ストレージアカウント名.blob.core.windows.net/vhds/複製元のディスク名.vhd?SAS&quot;</span> <span class="string">&quot;https://ストレージアカウント名.blob.core.windows.net/vhds/複製後のディスク名.vhd?SAS&quot;</span> -<span class="literal">-overwrite</span>=prompt -<span class="literal">-s2s</span><span class="literal">-preserve</span><span class="literal">-access</span><span class="literal">-tier</span>=false -<span class="literal">-recursive</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="2-復旧作業用の仮想マシンにて、複製した-VHD-ファイルをデータ-ディスクとしてアタッチします"><a href="#2-復旧作業用の仮想マシンにて、複製した-VHD-ファイルをデータ-ディスクとしてアタッチします" class="headerlink" title="2. 復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします"></a>2. 復旧作業用の仮想マシンにて、複製した VHD ファイルをデータ ディスクとしてアタッチします</h3><ol><li><p>復旧作業用の仮想マシンを作成します。<br>Azure Portal から [Virtual Machines] を開き、 [+ 追加] をクリックし、復旧対象仮想マシンと同様のリージョンにて、同様の OS バージョンの非管理ディスクを用いた仮想マシンを作成します。</p></li><li><p>複製した VHD ファイルをデータ ディスクとしてアタッチします。<br>Azure Portal から [Virtual Machines] - [&lt;復旧作業用の仮想マシン名&gt;] を開き、左メニュー “設定” の [ディスク] をクリックします。</p></li><li><p>開いた画面にて [+ データ ディスクの追加] をクリックします。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/4.png"></p><p>[ソースの種類] を [既存の BLOB] とし、[ソース BLOB] を手順 2 にて複製した VHD を選択します。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/5.png"></p><p>[OK] をクリックし、前の画面にて [保存] をクリックします。</p><p><img src="./noboot-recovery-unmsanaged-disk/6.png"></p></li><li><p>復旧作業用仮想マシンに RDP 接続し、追加したデータ ディスクが認識されるかを確認します。</p></li></ol><h3 id="3-復旧作業用仮想マシンにて、切り分けを実施します"><a href="#3-復旧作業用仮想マシンにて、切り分けを実施します" class="headerlink" title="3. 復旧作業用仮想マシンにて、切り分けを実施します"></a>3. 復旧作業用仮想マシンにて、切り分けを実施します</h3><p>下記 Windows OS 観点のブログに記載されている [3] - [6] をお試し下さい。</p><blockquote><p>OS が起動しなくなる問題が発生した場合の対処方法について – 対処方法<br><a href="https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/">https://jpwinsup.github.io/blog/2021/05/07/Performance/NoBoot/NoBoot-Solution/</a></p></blockquote><p>また、事象別のトラブルシューティングについては、下記公開情報に詳細が記載されています。併せてご確認ください。</p><blockquote><p>Azure 仮想マシンのブート エラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/boot-error-troubleshoot</a></p></blockquote><h3 id="4-修復した-VHD-を-Azure-PowerShell-にて現在の復旧対象の仮想マシンの-VHD-と差し替えます"><a href="#4-修復した-VHD-を-Azure-PowerShell-にて現在の復旧対象の仮想マシンの-VHD-と差し替えます" class="headerlink" title="4. 修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます"></a>4. 修復した VHD を Azure PowerShell にて現在の復旧対象の仮想マシンの VHD と差し替えます</h3><ol><li><p>Azure Portal より復旧作業用仮想マシンを停止 (割り当て解除) します。</p></li><li><p>Azure Portal から [Virtual Machines] - [&lt;復旧作業用の仮想マシン名&gt;] を開き、左メニュー “設定” の [ディスク] をクリックします。</p></li><li><p>データディスクをデタッチし、[保存] をクリックます。</p></li><li><p>復旧対象仮想マシンを停止 (割り当て解除) されていることを確認します。</p></li><li><p>PowerShell にて下記コマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#VM 情報の取得</span></span><br><span class="line"><span class="variable">$VM</span> = <span class="built_in">Get-AzVM</span> <span class="literal">-ResourceGroupName</span> リソースグループ名 <span class="literal">-name</span> 復旧対象仮想マシン名</span><br><span class="line"><span class="comment">#VHD ファイルの内容を差し替え</span></span><br><span class="line"><span class="variable">$VM</span>.StorageProfile.OsDisk.Vhd.Uri = <span class="string">&quot;修復した VHD ファイルのパス&quot;</span></span><br><span class="line"><span class="comment">#VM 情報の更新</span></span><br><span class="line"><span class="built_in">Update-AzVM</span> –VM <span class="variable">$VM</span> –ResourceGroupName リソースグループ名</span><br></pre></td></tr></table></figure><p>結果例：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RequestId IsSuccessStatusCode StatusCode ReasonPhrase</span><br><span class="line">--------- ------------------- ---------- ------------</span><br><span class="line">                         True         OK OK</span><br></pre></td></tr></table></figure><p>Azure PowerShell については、下記公開情報をご確認ください。</p><blockquote><p>Install the Azure Az PowerShell module<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps?view=azps-5.9.0">https://docs.microsoft.com/ja-jp/powershell/azure/install-az-ps?view=azps-5.9.0</a></p></blockquote></li><li><p>上記コマンド実施後、復旧対象仮想マシンの OS ディスクの参照先が変更されていることを確認します。</p><p><img src="/blog/vm/noboot-recovery-unmanaged-disk/7.png"></p></li><li><p>復旧対象仮想マシンを起動し、事象が解消されたかをご確認ください。</p></li></ol><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;br&gt;本記事では、Windows OS が起動しなくなる事象が発生した際に Windows OS の復旧手順を実施するために、起動ができない VM の OS ディスクを他の正常な VM にデータ ディスクとして接続する方法について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
</feed>
